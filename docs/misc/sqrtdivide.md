根号分治是一种特别的分治思想：它是以 $\sqrt N$ 为界分解问题的。

根号分治，是暴力美学的集大成体现。与其说是一种算法，不如称它为一个常用的 trick。

## 数论中的根号分治

### 常用结论

-   对于正整数 $n$ 和 $d \le n$，$\bigg\lfloor\dfrac{n}{d}\bigg\rfloor$ 至多只有 $2\lfloor\sqrt{n}\rfloor$ 种取值。具体地，对于 $d \le \lfloor\sqrt{n}\rfloor$ 和 $d > \lfloor\sqrt{n}\rfloor$，$\bigg\lfloor\dfrac{n}{d}\bigg\rfloor$ 分别最多只有 $\lfloor\sqrt{n}\rfloor$ 种取值。

该结论的一个典型应用是 [整除分块](/math/number-theory/sqrt-decomposition/)。

-   合数 $n$ 至少存在一个素因子 $p \le \lfloor\sqrt n\rfloor$。

该结论的一个典型应用是 [埃氏筛的筛至平方根优化](/math/number-theory/sieve/#筛至平方根)。

## 图论中的根号分治

### 常用结论

-   对于一个 $n$ 个点 $m$ 条边的无向图，度数 $\ge sqrt{2m}$ 的点至多只有 $\lfloor\sqrt{2m}\rfloor$ 个。

类似的结论也可用于有向图上。

### 例题

???+ note "[洛谷 P1989 无向图三元环计数](https://www.luogu.com.cn/problem/P1989)"
    给定一个 $n \le 10^5$ 个点 $m \le 2 \times 10^5$ 条边的简单无向图 $G = (V, E)$，求其三元环个数。

考虑此问题的暴力做法。首先枚举点 $u$，再枚举与其相连的点 $v$，最后枚举 $v$ 有多少个与其相连的点 $w$ 满足与 $u$ 也相连。

注意到三个点的顺序无关紧要，取原图的一个有向无环诱导生成子图 $G^\prime = (V, E^\prime)$ 后再暴力可避免不必要的重复计数。此时枚举点 $u$ 时对其所有出边连接的点打上时间戳，则枚举与其相连的点 $v$ 后，只需获取 $v$ 的出边连接的点 $w$ 的时间戳即可 $O(1)$ 判断 $u, w$ 是否相连。

对于每个点 $v$：

-   其在 $G$ 的度数记为 $d(v)$；
-   其在 $G^\prime$ 的出度记为 $d^{+}(v)$。

记 $(u \to v)$ 为 $G^\prime$ 里从点 $u$ 指向点 $v$ 的边。

那么上述算法的时间复杂度为：

$$
\sum_{(u \to v) \in E^\prime} d^{+}(v)
$$

现在关键来到了如何生成合适的子图使得每个点 $v$ 的 $d^{+}(v)$ 尽可能小来降低时间复杂度。

此时便有根号分治的用武之地。将 $G$ 的点集 $V$ 划分为 **轻点集**  $L$ 和 **重点集**  $H$：

$$
\begin{aligned}
L &= \{v \mid v \in V \land d(v) < \sqrt{2m}\} \\
H &= \{v \mid v \in V \land d(v) \ge \sqrt{2m}\}
\end{aligned}
$$

首先对于所有点 $v$ 都有 $d^{+}(v) \le d(v)$ 成立，故对于所有的 $v \in L$ 都有 $d^{+}(v) < \sqrt{2m}$ 成立。

由上一节的结论可知 $|H| \le \lfloor\sqrt{2m}\rfloor$，则对于所有的 $(u, v) \in E$：

1.  $u, v \in H$：对 $H$ 任意生成一个有向无环诱导子图；
2.  $u \in L, v \in H$：将 $(u \to v)$ 加入 $E^\prime$；

即可使 $d^{+}(u), d^{+}(v) \le \lfloor\sqrt{2m}\rfloor$。

3.  $u, v \in L$：对 $L$ 任意生成一个有向无环诱导子图；

此时 $G^\prime$ 就是有向无环诱导生成子图。

此时时间复杂度 $O(m\sqrt m)$，注意一下常数优化即可通过此题。典型的参考实现：让度数低的点连向度数高的点，度数相同的令编号小的连向编号大的。

## 序列问题的根号分治

### 常用结论

-   对于一个长度为 $n$ 的序列 $\langle a_i \rangle$，相同元素出现次数 $\ge \sqrt n$ 的元素最多只有 $\lfloor\sqrt n\rfloor$ 种。

### 例题

???+ note "[P1494 \[国家集训队\] 小 Z 的袜子](https://www.luogu.com.cn/problem/P1494)"
    给定一个长度为 $N \le 5 \times 10^4$ 的序列 $\langle C_i \rangle$ 表示袜子的颜色，$M \le 5 \times 10^4$ 次询问区间 $[L, R]$ 内有多大概率抽到两只颜色相同的袜子。

由古典概率可知每次询问的答案即为：

$$
\frac{\sum_{L \le i < j \le R}[C_i = C_j]}{\binom{R + 1 - L}{2}}
$$

问题转化为计算区间内相同无序点对的数量。为人熟知的做法是使用普通莫队算法，但此题也可以用根号分治在相同的复杂度内完成。对于每种颜色 $c$，考虑其出现的次数 $t_c$：

1.  $t_c \ge \sqrt N$：这样的颜色最多只有 $\lfloor\sqrt N\rfloor$ 种。

预处理出每种颜色 $c$ 出现次数的前缀和，询问时暴力枚举每种颜色 $c$ 的出现次数 $t_c$ 后将答案累加上 $\dbinom{t_c}{2}$ 即可。

时间复杂度：预处理 $O(N\sqrt N)$，单次询问 $O(\sqrt N)$，所有询问 $O(M\sqrt N)$，合计 $O((N + M)\sqrt N)$。

2.  $t_c < \sqrt N$：这样的颜色总计能产生的相同点对数量不超过 $O(N\sqrt N)$ 的数量级。

建立一个数组 $\langle b_j \rangle$，表示当前对于每个位置 $j$，有 $b_j$ 个颜色相同的在其之后。再对于每种颜色用列表记录其出现过的下标。

对于所有询问按其右端点 $R$ 升序排序。顺序枚举 $i \in [1, n]$，遇到第 2 类颜色就更新一次数组 $\langle b_j \rangle$，更新时使用记录过的下标来降低复杂度，之后更新记录过的下标。当 $i = R$ 时，区间 $[L, R]$ 内的 $\sum b_j$ 即为该区间内第 2 类相同颜色的点对数，将其累加进答案然后处理下一询问。

时间复杂度：预处理为排序的时间复杂度，$O(N\sqrt N)$ 次单点自增，$O(M)$ 次区间求和，而块状数组的单点自增复杂度为 $O(1)$，区间求和复杂度为 $O(\sqrt N)$，因此合计 $O((N + M)\sqrt N)$。

将上述两种做法的结果直接相加即可得到答案，总时间复杂度 $O((N + M)\sqrt N)$。

## 例题

下面引入一些题目介绍该思想：

### 例题 1

???+ note "[CF1207F Remainder Problem](https://codeforces.com/problemset/problem/1207/F)"
    给定一个长度为 $n = 5 \times 10^5$ 的序列 $a$，初值为 $0$。要完成 $q \le 5 \times 10^5$ 次操作，操作有如下两种：
    
    1.  `1 x y`：将下标为 $x$ 的位置的值加上 $y$；
    2.  `2 x y`：询问所有下标模 $x$ 的结果为 $y$ 的位置的值之和，即计算：
    
    $$
    f(x, y) = \sum_{k \equiv y \pmod{x}} a_k
    $$

考虑这题的暴力是什么。

暴力 I：直接按照题目所说的去做，开一个长度为 $n$ 的数组 $a$ 去存，操作 1 就对 $a_x$ 加上 $y$，操作 2 就枚举所有满足 $k \equiv y \pmod{x}$ 的下标 $k$，计算 $a_k$ 的和。

对于这种暴力，操作 1 的时间复杂度为 $O(1)$，操作 2 的时间复杂度为 $O(n)$，所以在最坏情况下总时间复杂度可达 $O(nq)$。

暴力 II：开一个大小为 $n \times n$ 的二维数组 $b$，其中 $b_{x,y}$ 记录当前的 $f(x,y)$。此时对于操作 1，枚举所有的模数 $m$，将 $b_{m,x \bmod m}$ 加上 $y$ 即可；对于操作 2，直接输出 $b_{x,y}$ 即可。

对于这种暴力，操作 1 的时间复杂度为枚举模数的 $O(n)$，操作 2 的时间复杂度为 $O(1)$，所以在最坏情况下总时间复杂度可达 $O(nq)$。

上述两种暴力对应了两种极端：

-   暴力 I：操作 1 的时间复杂度为 $O(1)$，操作 2 的时间复杂度为 $O(n)$；
-   暴力 II：操作 1 的时间复杂度为 $O(n)$，操作 2 的时间复杂度为 $O(1)$。

那么，有没有办法让这两种暴力融合一下，均摊时间复杂度，达到一个平衡呢？

有，可以使用根号分治将两种暴力法结合起来。首先设定一个阈值 $B$。

对于操作 1，使用暴力 I 的同时：

-   若 $x \le B$，则维护暴力 II 的 $b$ 数组。此时每次操作 1 只需要枚举前 $B$ 个模数即可，故单次操作 1 的时间复杂度降为 $O(B)$；
-   若 $x > B$，则不维护暴力 II 的 $b$ 数组。

对于操作 2：

-   若 $x \le B$，使用暴力 II 的 $b$ 数组直接输出即可；
-   若 $x > B$，使用暴力 I。由于所有满足 $k \equiv y \pmod{x}$ 的下标 $k$ 必定是 $y + rx$ 的形式（其中 $r \in \mathbf Z$），因此最多有 $\lceil n / B\rceil$ 种取值，故单次操作 2 的时间复杂度降为 $O(n / B)$。

综上总时间复杂度变为了 $O(q(B + n / B))$，取 $B = \sqrt n$ 可以使 $B + n / B$ 达到最小值 $2\sqrt n$，此时总时间复杂度为 $O(q\sqrt n)$，空间复杂度 $O(n)$，可以通过此题。

??? "参考代码"
    ```cpp
    --8<-- "docs/misc/code/sqrtdivide/sqrtdivide_1.cpp"
    ```

通过一道例题可以发现：根号分治不就是两个暴力揉到一起嘛！对于小于一个阈值的数据采取一种暴力形式，对于大于阈值的数据采用另外一种形式。通常，这两种暴力，一种是直接模拟，另外一种是动态的维护什么东西，或者预处理。暴力与暴力的完美结合，就能过题，有时候甚至可以爆踩标算。

## 参考资料

-   [暴力美学——浅谈根号分治](https://www.luogu.com.cn/blog/Amateur-threshold/pu-li-mei-xue-qian-tan-gen-hao-fen-zhi#)
