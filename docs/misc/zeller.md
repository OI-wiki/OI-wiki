author:marscheng1

在 CSP 初赛中，我们经常会遇到这样的问题：已知某年某月某日星期几，问另外一个日期是星期几。
这种问题虽然可以手算每年多少天，但是这种方法容易出错，同时如果在复赛的模拟中遇到也不好办。
但是使用蔡勒公式，这类问题便迎刃而解。

## 蔡勒公式

蔡勒公式是用来计算任意日期是星期几的公式，其公式如下：

$$
w = (y + \lfloor\frac{c}{4}\rfloor + \lfloor\frac{y}{4}\rfloor - 2c + \lfloor\frac{13 * (m + 1)}{5}\rfloor + d - 1) \mod 7
$$

其中：

-   $w$：星期几，0 表示星期日，1 表示星期一，2 表示星期二，3 表示星期三，4 表示星期四，5 表示星期五，6 表示星期六。
-   $c$：年份的前两位数，如 2022 年为 20，实现时可以用 $y/100$ 取整。
-   $y$：年份的后两位数，如 2022 年为 22，实现时可以用 $y\mod 100$。
-   $m$：月份，1 月和 2 月要看作上一年的 13 月和 14 月来计算，如 2022 年 2 月 1 日，看成 2021 年 14 月 1 日，实现时要注意它可能会影响 $c$ 和 $y$ 的取值。
-   $d$：日期。

注意此公式只适用于格里高利历（现行公历）

??? note "公式推导"
    我们可以先思考解决这个问题的最简单的方式，即从一个已知星期几的日期开始，然后计算这个日期与要求的日期之间的天数，然后根据天数并取模就可以计算出星期几。根据这个思路，就可以推导出蔡勒公式。
    首先，我们知道，公元元年 1 月 1 日是星期一，往后计算，显然公元后经过的天数模$7$后的余数与当时星期几一一对应，即：0 表示星期日，1 表示星期一，2 表示星期二，3 表示星期三，4 表示星期四，5 表示星期五，6 表示星期六。
    所以，我们需要计算该日期是公元元年 1 月 1 日开始数的多少天。
    
    首先设该天数为 $D$，则 $D$ 由两部分组成，即 $D = D_1 + D_2$ 其中 $D_1$ 表示从公元元年 1 月 1 日开始数到当前前一年 12 月 31 年经过的天数，$D_2$ 表示当前年经过的天数。
    
    显然因为一年 365 天，而闰年比平年多一天，所以 $D_1$ 等于 $(y - 1) * 365$ 加上闰年数量，根据 4 年一闰，100 年不闰，400 年又闰的规则，可以写出公式：
    
    $$
    D_1 = 365 * (y - 1) + \lfloor\frac{y - 1}{4}\rfloor - \lfloor\frac{y - 1}{100}\rfloor + \lfloor\frac{y - 1}{400}\rfloor
    $$
    
    那 $D_2$ 又应该如何计算呢，我们发现闰年时二月多一天，这一点的实现需要很多复杂的判断，所以不妨考虑将 1 月和 2 月看成上一年的 13 月和 14 月来计算，这样就可以避免闰年的判断，然后考虑月份，即从今年一月一号到上个月最后一天天的天数，经过构造，我们发现可以使用 $(m - 1) * 28 + \lfloor\frac{13 * (m + 1)}{5}\rfloor - 7$ 表示到到上个月最后一天天的天数，然后加上 $d$ 就可得到
    
    $$
    D_2 = (m - 1) * 28 + \lfloor\frac{13 * (m + 1)}{5}\rfloor - 7 + d
    $$
    
    因为我们将 1 月和 2 月看成上一年的 13 月和 14 月来计算，所以关于闰年的计算也要修改，比如我们计算公元 4 年 3 月 1 日，实际上认为公元 3 年 14 月加一天，所以 $D_1$ 的表达式需要改为
    
    $$
    D_1 = 365 * (y - 1) + \lfloor\frac{y}{4}\rfloor - \lfloor\frac{y}{100}\rfloor + \lfloor\frac{y}{400}\rfloor
    $$
    
    所以最后的 $D$ 为
    
    $$
    D = 365 * (y - 1) + \lfloor\frac{y}{4}\rfloor - \lfloor\frac{y}{100}\rfloor + \lfloor\frac{y}{400}\rfloor + (m - 1) * 28 + \lfloor\frac{13 * (m + 1)}{5}\rfloor - 7 + d
    $$
    
    星期数就是
    
    $$
    w = (365 * (y - 1) + \lfloor\frac{y}{4}\rfloor - \lfloor\frac{y}{100}\rfloor + \lfloor\frac{y}{400}\rfloor + (m - 1) * 28 + \lfloor\frac{13 * (m + 1)}{5}\rfloor - 7 + d) \mod 7
    $$
    
    对该式进行构造和化简后，可以得到最简的式子（具体的化简过程见参考资料 1）
    
    $$
    w = (y + \lfloor\frac{c}{4}\rfloor + \lfloor\frac{y}{4}\rfloor - 2c + \lfloor\frac{13 * (m + 1)}{5}\rfloor + d - 1) \mod 7
    $$

## 示例代码

???+ note "示例代码"
    ```cpp
    int day(int y, int m, int d) {
      // 1 月和 2 月看成上一年的 13 月和 14 月
      if (m == 1 || m == 2) {
        y--;
        m += 12;
      }
      int c = y / 100;
      int yy = y % 100;
      int ans = (yy + yy / 4 + c / 4 - 2 * c + 13 * (m + 1) / 5 + d - 1) % 7;
      // 由于 % 的结果可能能为负数，所以需要加 7
      if (ans < 0) ans += 7;
      return ans
    }
    ```

## 参考资料
1. [蔡勒(Zeller)公式及其推导：快速将任意日期转换为星期数](https://www.cnblogs.com/faterazer/p/11393521.html)
