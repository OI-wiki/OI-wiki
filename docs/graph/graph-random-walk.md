本页介绍随机游走问题。主要从网格图、稀疏图、一般图三个角度进行探究，介绍了解决这类问题的各种方法，并对比了它们在解决各种问题时的优缺点。

## 定义

给定一张有向简单图 $G=(V, E)(V=\{v_1, v_2, \cdots, v_{|V|}\})$ 和起点 $v_s \in V$,终点 $v_t \in V$,每条边 $e=\left(v_x, v_y\right)$ 有正权值 $w_e$,满足 $\forall v_x \in V \backslash\left\{v_t\right\}, \sum_{\left(v_x, v_y\right) \in E} w_{\left(v_x, v_y\right)}=1$,且对于任意点 $v_x$ 都存在一条从 $v_x$ 出发到达 $v_t$ 的路径。有一枚棋子从起点出发,每秒从当前所在点 $v_x$ 以 $w_{v_x, v_y}$ 的概率选择出边 $\left(v_x, v_y\right)$ 并走向 $v_y$,到达终点则停止,求期望花费时间。

事实上,这个问题也可以写成矩阵的形式。定义矩阵 $P$ :
$$
P_{x, y}=\left\{\begin{array}{ll}

w_{\left(v_x, v_y\right)} & \left(v_x, v_y\right) \in E \text { 且 } x \neq t \\

0 & \left(v_x, v_y\right) \notin E \text { 或 } x=t

\end{array}\right.
$$
要求的答案即为:
$$
\sum_{k \geq 0} k \times\left(P^k\right)_{s, t}
$$
其中 $\left(P^k\right)_{s, t}$ 表示走了 $k$ 步第一次到达终点的概率。当图有限且所有点都能到达终点时, 由 $P$ 的定义可以证明其特征值都小于 1 , 所以答案一定是收敛的。

为了方便描述, 在本页中如无特殊说明, 均用 $n$ 代指 $|V|, m$ 代指 $|E|$ 。

另外, 在本页中, 稀疏图指边数和点数同阶的图。

## 网格图

???+ note "例题1 Circles of Waiting"
    有一枚棋子起始被放在平面直角坐标系的 $(0,0)$ 点。每秒棋子会随机移动。假设它当 前在 $(x, y)$ ， 它下一秒有 $p_1$ 的概率移动到 $(x-1, y), p_2$ 的概率移动到 $(x, y-1), p_3$ 的 概率移动到 $(x+1, y), p_4$ 的概率移动到 $(x, y+1)$ 。保证 $p_1+p_2+p_3+p_4=1$ 。求期望 经过多少时间它会移动到一个离原点的欧几里得距离大于 $R$ 的位置。
    $0 \leq R \leq 50, p_1, p_2, p_3, p_4>0$, 答案对 $10^9+7$ 取模。

### 朴素做法

记 $f(i, j)$ 表示在棋子在 $(i, j)$ 时移动到一个离原点的欧几里得距离大于 $R$ 的位置的期望时间，转移方程为:
$$
f(i, j)=\left\{\begin{array}{ll}

p_1 f(i-1, j)+p_2 f(i, j-1)+p_3 f(i+1, j)+p_4 f(i, j+1)+1 & i^2+j^2 \leq R \\

0 & i^2+j^2>R

\end{array}\right.
$$
由于转移并不存在拓扑序，需要使用高斯消元求解。时间复杂度 $O\left(R^6\right)$，无法通过本题。

### 直接消元法

注意到需要消元的方程的系数大多数都是 0 , 消元时只对值非 0 的位置进行计算就可以降低复杂度。

考虑消元的过程，将方程按照在坐标系中从上到下，同一层中从左到右的顺序进行消元, 将已经消元过的方程染成黄色, 与黄色点相邻的点染成绿色, 其余点染成黑色, 如下图：

![graph-random-walk](images/graph-random-walk-1.svg)

接下来要对下一个绿色格子对应的方程进行消元。在这个方程中, 只有绿色格子和它下方的第一个黑色格子对应的变量系数可能不为 0 ; 而只有绿色格子和它下方的第一 个黑色格子对应的方程中, 当前格子对应的变量系数可能不为 0 。

注意到绿色格子只有 $O(R)$ 个, 所以单个方程消元的时间复杂度为 $O\left(R^2\right)$ 。一共只有 $O\left(R^2\right)$ 个方程, 所以时间复杂度降低为 $O\left(R^4\right)$, 可以通过本题。

### 主元法

方程和变量都有 $O\left(R^2\right)$ 个, 如果能将规模缩小至 $O(R)$ ，那么朴素的高斯消元就能通过了。

将每行从左到右第一个格子对应的变量设为主元, 共 $2 R+1$ 个, 设法将其他格子对应的变量用关于这些主元的线性函数表示。从左到右逐列考虑, 对于当前列的每个格子 $(i, j)$ ,注意到 $f(i, j), f(i-1, j), f(i, j-1), f(i, j+1)$ 都是已知的关于主元的线性函数, 将转移方程移项, 有:
$$
f(i+1, j)=\frac{f(i, j)-p_1 f(i-1, j)-p_2 f(i, j-1)-p_4 f(i, j+1)-1}{p_3}
$$
这样就能得到 $f(i+1, j)$ 关于主元的线性函数表示。如果 $(i+1, j)$ 已经离原点欧几里得距离超过 $R$ 了, 则可以得到一个方程: $f(i+1, j)=0$ 。最终, 会得到 $2 R+1$ 个方程, 对这些方程进行高斯消元即可。

在递推关于主元的线性函数的阶段, 共有 $O\left(R^2\right)$ 个变量, 递推单个变量需要花费$O(R)$的时间；之后，将问题的规模缩减到了 $O(R)$ 。两部分的时间复杂度均为 $O\left(R^3\right)$，总的时间复杂度也为 $O\left(R^3\right)$，可以通过本题。

### 两种做法的对比

从多种方面对比两种做法：

从时间复杂度方面, 主元法在网格图上的最坏时间复杂度为 $O(n \sqrt{n})$ （当网格图长和宽都为 $O(\sqrt{n})$ 级别时时间复杂度最高), 直接消元法在网格图上最坏时间复杂度为 $O\left(n^2\right)$, 主元法较优。

从精度方面, 对于一些需要进行实数计算而不是取模的题目, 直接消元法的精度优于主元法。

从适用性方面，两种做法适用于不同的方面。

当网格图中存在障碍或者走某些边的概率为 $0$ 时, 对于每个障碍或者概率为 $0$ 的边主元法需要增加一个主元, 当障碍或者概率为 $0$ 的边的数量多于 $O(R)$ 时, 主元法的时间复杂度会增加, 而直接消元法的时间复杂度仍然不变。

但主元法还可以做类似于网格图的转移方程的消元, 例如 $f(i, j)=p_1 f(i+1, j)+p_2 f(i, j+1)+p_3 f(\operatorname{pre}(i, j))+1$，其中 $\operatorname{pre}(i, j)=(x, y)(x \leq i, y \leq j)$ 是问题给定的值, 而直接消元法的复杂度分析在这种模型中并不适用。

除此以外, 网格图邻接矩阵行列式的计算, 也不能使用主元法, 只能用直接消元法来优化时间复杂度。

综上, 两种做法各有所长, 需要根据具体题目分析采用不同的做法。

## 稀疏图

???+ note "例题2 Expected Value"
    给定一张简单无向连通平面图 $G=(V, E)$, 有一枚棋子起始被放在 $v_1$, 每秒棋子会从与当前点相连的边中等概率选择一条走到出边指向的点, 求到达 $v_n$ 的期望时间。
    $n \leq 2000$ ，答案对 $p$ 取模, $p$ 是在区间 $\left[10^9, 1.01 \times 10^9\right]$ 内随机生成的一个质数。

一个结论是, 平面图的边数和点数是同阶的。具体地, 我们有:

定理 4.1. 一个 $n(n \geq 3)$ 个点的平面图, 其边数 $m$ 不超过 $3n-6$。

由于本题的做法能拓展到任意稀疏图上, 所以接下来的讨论只基于本题边数和点数同 阶这个条件, 而不需要平面图的其他性质。

### 基础知识

定义 4.1. 所有满足 $p(A) = 0$ 的多项式 $p(λ)$ 称为矩阵 $A$ 的零化多项式。  

定义 4.2. 记 $I_n$ 表示 $n$ 阶单位矩阵，定义一个 $n × n$ 矩阵 $A$ 的特征多项式为 $p(λ) = det(λI_n - A)$ ，其中 $det$ 表示一个矩阵的行列式。
不难发现，一个 $n$ 阶矩阵 $A$ 的特征多项式的次数不超过 $n$ 。
定理 4.2. （Cayley–Hamilton定理）任意矩阵的特征多项式是它的零化多项式。
所以，一个 $n$ 阶矩阵的次数最小的零化多项式的次数也不超过 $n$ 。  

### 求解原问题

注意到，期望走的时间 $E(t)=\sum_{i\geq0}\Pr[t>i]$ ，如果我们能求出走了 $i$ 步还没有结束的 概率，对所有 $i ≥ 0$ 求和即为答案。

记 $f(i, j)$ 表示走了 $i$ 步，当前停留在 $v_j$ ，且没有走到过 $v_n$ 的概率，那么有：
$$
f(i,j)=\sum_{(\nu_k,\nu_j)\in E}\frac{f(i-1,k)}{deg_k}(j\neq n)
$$
其中 $deg_k$ 表示 $v_k$ 的度数。 

注意到 $f$ 的转移与 $i$ 无关，可以认为一次转移是乘上了一个矩阵，即 $f{i+1}=f_iM$ 。 由于 $M$ 的最小零化多项式次数不超过 $n$ ，所以 $f$ 的最短递推式长度也不超过 $n$ ，故 $\Pr[t>i]=\sum_{j=1}^{n-1}f(i,j)$ 的最短递推式长度也不超过 $n$ 。我们可以在 $O(nm)$ 的时间求出 $\Pr[t>0],\Pr[t>1],\cdots,\Pr[t>3n]$，然后使用 Berlekamp–Massey 算法，在 $O(n^2)$ 的时间 内求解出 $\Pr[t > i]$ 的最短递推式。 

考虑求一个 k 阶线性递推序列 a 的生成函数。不妨设 $i ≥ i_0$ 时 $a_i=\sum_{j=1}^kc_ja_{i-j}$ ，记 $a$ 和 $c$ 的生成函数为 $A(x)$ 和 $C(x)$ ，那么 $A(x)=A(x)C(x)+A_0(x)$，其中 $A_0(x)$ 是由 $i ≥ i_0$ 的项决定的。 

回到原问题，由于我们能求出 $\Pr[t > i]$ 的最短递推式，则我们可以求出 $C(x)$ 和 $A_0(x) $（定义与上一段相同），移项得 $A(x)=\frac{A_0(x)}{1-C(x)}$。我们要求的是 $\sum_{i\geq0}[x^i]A(x)$ ，不难发现这个值 就等于 $A(1)$ ，将 $x = 1$ 带入原问题求解即可。由于模数是随机质数，可以认为分母不会为 $0$ 。 

这样，我们就在 $O(nm+n^2)$ 的时间复杂度内解决了本题。由于点数与边数同阶，所以本题中时间复杂度可以认为是 $O(n^2)$ 。

## 一般图

???+ note "例题3 Frank"
    给定一张简单强连通有向图 $G = (V, E)$ ，对于所有 $1 ≤ s ≤ n$, $1 ≤ t ≤ n$, $s ≠ t$ 回答下面的问题： 
    有一枚棋子起始被放在 $v_s$ ，每秒棋子会从当前点的出边中等概率选择一条走到出边指向的点，求到达 $v_t$ 的期望时间。 
    $3 ≤ n ≤ 400$ 。

### 分析和转化

记 $p_{i, j}$ 表示棋子在 $v_i$ 时，选择出边 $(v_i, v_j)$ 走到 $v_j$ 的概率，特别地，当出边不存在时
概率为 $0$ 。记 $f_{i,j}$ 表示 $v_i$ 随机游走到 $v_j$ 的期望时间，特别地， $f_{i,i} = 0$ 。当 $i ≠ j$ 时，转移
方程为：  
$$
f_{i,j}=1+\sum_{1\leq k\leq n}p_{i,k}f_{k,j}
$$
当 $i = j$ 时，记 $g_i$ 表示从 $v_i$ 开始随机游走，第一次回到 $v_i$ 的期望时间，那么：  
$$
f_{i,i}=1-g_i+\sum_{1\le k\le n}p_{i,k}f_{k,i}
$$
为了方便观察，我们将转移方程写成矩阵的形式。记 $P$ 表示这个图的转移矩阵， $F$ 表
示答案矩阵， $I$ 表示 $n$ 阶单位矩阵， $J$ 表示 $n$ 阶全 $1$ 矩阵， $G$ 是一个 $n$ 阶矩阵，满足 $G_{i,i} = g_i$
，其他位置为 $0$ ，则：  
$$
F=J-G+PF
$$
如果我们能求出 $G$，那么我们只需要解方程：  
$$
(I − P)F = J − G
$$


### G的求法



### 求解原问题



## 参考

1. 国家集训队2019论文集
2. 
