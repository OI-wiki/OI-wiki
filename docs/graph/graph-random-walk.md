本页面介绍随机游走问题。主要从网格图、稀疏图、一般图三个角度进行探究，介绍了解决这类问题的各种方法，并对比了它们在解决各种问题时的优缺点。

## 定义

给定一张有向简单图 $G=(V, E)(V=\{v_1, v_2, \cdots, v_{|V|}\})$ 和起点 $v_s \in V$,终点 $v_t \in V$,每条边 $e=\left(v_x, v_y\right)$ 有正权值 $w_e$,满足 $\forall v_x \in V \backslash\left\{v_t\right\}, \sum_{\left(v_x, v_y\right) \in E} w_{\left(v_x, v_y\right)}=1$,且对于任意点 $v_x$ 都存在一条从 $v_x$ 出发到达 $v_t$ 的路径。有一枚棋子从起点出发,每秒从当前所在点 $v_x$ 以 $w_{v_x, v_y}$ 的概率选择出边 $\left(v_x, v_y\right)$ 并走向 $v_y$,到达终点则停止,求期望花费时间。

事实上,这个问题也可以写成矩阵的形式。定义矩阵 $P$ :
$$
P_{x, y}=\left\{\begin{array}{ll}

w_{\left(v_x, v_y\right)} & \left(v_x, v_y\right) \in E \text { 且 } x \neq t \\

0 & \left(v_x, v_y\right) \notin E \text { 或 } x=t

\end{array}\right.
$$
要求的答案即为:
$$
\sum_{k \geq 0} k \times\left(P^k\right)_{s, t}
$$
其中 $\left(P^k\right)_{s, t}$ 表示走了 $k$ 步第一次到达终点的概率。当图有限且所有点都能到达终点时, 由 $P$ 的定义可以证明其特征值都小于 1 , 所以答案一定是收敛的。

为了方便描述, 在本文中如无特殊说明, 均用 $n$ 代指 $|V|, m$ 代指 $|E|$ 。

另外, 在本文中, 稀疏图指边数和点数同阶的图。

## 网格图

???+ note "例题 Circles of Waiting"
    有一枚棋子起始被放在平面直角坐标系的 $(0,0)$ 点。每秒棋子会随机移动。假设它当 前在 $(x, y)$ ， 它下一秒有 $p_1$ 的概率移动到 $(x-1, y), p_2$ 的概率移动到 $(x, y-1), p_3$ 的 概率移动到 $(x+1, y), p_4$ 的概率移动到 $(x, y+1)$ 。保证 $p_1+p_2+p_3+p_4=1$ 。求期望 经过多少时间它会移动到一个离原点的欧几里得距离大于 $R$ 的位置。
    $0 \leq R \leq 50, p_1, p_2, p_3, p_4>0$, 答案对 $10^9+7$ 取模。

### 朴素做法

记 $f(i, j)$ 表示在棋子在 $(i, j)$ 时移动到一个离原点的欧几里得距离大于 $R$ 的位置的期望时间，转移方程为:
$$
f(i, j)=\left\{\begin{array}{ll}

p_1 f(i-1, j)+p_2 f(i, j-1)+p_3 f(i+1, j)+p_4 f(i, j+1)+1 & i^2+j^2 \leq R \\

0 & i^2+j^2>R

\end{array}\right.
$$
由于转移并不存在拓扑序，需要使用高斯消元求解。时间复杂度 $O\left(R^6\right)$，无法通过本题。

### 直接消元法

注意到需要消元的方程的系数大多数都是 0 , 消元时只对值非 0 的位置进行计算就可以降低复杂度。

考虑消元的过程，将方程按照在坐标系中从上到下，同一层中从左到右的顺序进行消元, 将已经消元过的方程染成黄色, 与黄色点相邻的点染成绿色, 其余点染成黑色, 如下图：



接下来我们要对下一个绿色格子对应的方程进行消元。在这个方程中, 只有绿色格子和它下方的第一个黑色格子对应的变量系数可能不为 0 ; 而只有绿色格子和它下方的第一 个黑色格子对应的方程中, 当前格子对应的变量系数可能不为 0 。

注意到绿色格子只有 $O(R)$ 个, 所以单个方程消元的时间复杂度为 $O\left(R^2\right)$ 。一共只有 $O\left(R^2\right)$ 个方程, 所以时间复杂度降低为 $O\left(R^4\right)$, 可以通过本题。

### 主元法

方程和变量都有 $O\left(R^2\right)$ 个, 如果能将规模缩小至 $O(R)$ ，那么朴素的高斯消元就能通过了。

将每行从左到右第一个格子对应的变量设为主元, 共 $2 R+1$ 个, 设法将其他格子对应的变量用关于这些主元的线性函数表示。从左到右逐列考虑, 对于当前列的每个格子 $(i, j)$ ,注意到 $f(i, j), f(i-1, j), f(i, j-1), f(i, j+1)$ 都是已知的关于主元的线性函数, 将转移方程移项, 有:
$$
f(i+1, j)=\frac{f(i, j)-p_1 f(i-1, j)-p_2 f(i, j-1)-p_4 f(i, j+1)-1}{p_3}
$$
这样我们就能得到 $f(i+1, j)$ 关于主元的线性函数表示。如果 $(i+1, j)$ 已经离原点欧几里得距离超过 $R$ 了, 则可以得到一个方程: $f(i+1, j)=0$ 。最终, 我们会得到 $2 R+1$ 个方程, 对这些方程进行高斯消元即可。

在递推关于主元的线性函数的阶段, 共有 $O\left(R^2\right)$ 个变量, 递推单个变量需要花费$O(R)$的时间；之后, 我们将问题的规模缩减到了 $O(R)$ 。两部分的时间复杂度均为 $O\left(R^3\right)$, 总的时间复杂度也为 $O\left(R^3\right)$, 可以通过本题。

### 两种做法的对比

## 稀疏图

### 求解原问题

## 一般图

## 分析和转化

