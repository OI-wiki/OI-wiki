author: minghu6

*æœ¬ç« èŠ‚å†…å®¹éœ€è¦ä»¥ [ã€Šå‰ç¼€å‡½æ•°ä¸ KMP ç®—æ³•ã€‹](./kmp.md) ä½œä¸ºå‰ç½®ç« èŠ‚ã€‚*

ä¹‹å‰çš„ KMP ç®—æ³•å°†å‰ç¼€åŒ¹é…çš„ä¿¡æ¯ç”¨åˆ°äº†æè‡´ï¼Œ

è€Œ BM ç®—æ³•èƒŒåçš„åŸºæœ¬æ€æƒ³æ˜¯é€šè¿‡åç¼€åŒ¹é…è·å¾—æ¯”å‰ç¼€åŒ¹é…æ›´å¤šçš„ä¿¡æ¯æ¥å®ç°æ›´å¿«çš„å­—ç¬¦è·³è½¬ã€‚

## åŸºç¡€ä»‹ç»

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬çš„çš„æ¨¡å¼å­—ç¬¦ä¸² $pat$ï¼Œè¢«æ”¾åœ¨æ–‡æœ¬å­—ç¬¦ä¸² $string$ çš„å·¦æ‰‹èµ·å¤´éƒ¨ï¼Œä½¿å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—ç¬¦å¯¹é½ã€‚

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\texttt{EXAMPLE} \\
\textit{string}:\qquad\quad &\texttt{HERE IS A SIMPLE EXAMPLE} \dots \\
&\qquad\ \ \ \, \, \Uparrow
\end{aligned}
$$

åœ¨è¿™é‡Œåšå®šä¹‰ï¼Œå¾€åä¸èµ˜è¿°ï¼š

$pat$ çš„é•¿åº¦ä¸º $patlen$ï¼Œç‰¹åˆ«åœ°å¯¹äºä» 0 å¼€å§‹çš„ä¸²æ¥è¯´ï¼Œè§„å®š $patlastpos=patlen-1$ ä¸º $pat$ ä¸²æœ€åä¸€ä¸ªå­—ç¬¦çš„ä½ç½®ï¼›

$string$ çš„é•¿åº¦ $stringlen$ï¼Œ$stringlastpos = stringlen-1$ã€‚

å‡å¦‚æˆ‘ä»¬çŸ¥é“äº† $string$ çš„ç¬¬ $patlen$ ä¸ªå­—ç¬¦ $char$ï¼ˆä¸ $pat$ çš„æœ€åä¸€ä¸ªå­—ç¬¦å¯¹é½ï¼‰è€ƒè™‘æˆ‘ä»¬èƒ½å¾—åˆ°ä»€ä¹ˆä¿¡æ¯ï¼š

**è§‚å¯Ÿ 1**ï¼š

å¦‚æœæˆ‘ä»¬çŸ¥é“ $char$ è¿™ä¸ªå­—ç¬¦ä¸åœ¨ $pat$ ä¸­ï¼Œæˆ‘ä»¬å°±ä¸ç”¨è€ƒè™‘ $pat$ ä» $string$ çš„ç¬¬ $1$ ä¸ªã€ç¬¬ $2$ ä¸ªâ€¦â€¦ç¬¬ $patlen$ ä¸ªå­—ç¬¦èµ·å‡ºç°çš„æƒ…å†µï¼Œï¼Œè€Œå¯ä»¥ç›´æ¥å°† $pat$ å‘ä¸‹æ»‘åŠ¨ $patlen$ ä¸ªå­—ç¬¦ã€‚

**è§‚å¯Ÿ 2**ï¼š

æ›´ä¸€èˆ¬åœ°ï¼Œ**å¦‚æœå‡ºç°åœ¨ $pat$ æœ€æœ«å°¾ï¼ˆä¹Ÿå°±æ˜¯æœ€å³è¾¹ï¼‰çš„é‚£ä¸€ä¸ª $char$ å­—ç¬¦çš„ä½ç½®æ˜¯ç¦»æœ«å°¾ç«¯å·®äº† $delta_1$ ä¸ªå­—ç¬¦**ï¼Œ

é‚£ä¹ˆå°±å¯ä»¥ä¸ç”¨åŒ¹é…ï¼Œç›´æ¥å°† $pat$ å‘åæ»‘åŠ¨ $delta_1$ ä¸ªå­—ç¬¦ï¼šå¦‚æœæ»‘åŠ¨è·ç¦»å°‘äº $delta_1$ï¼Œé‚£ä¹ˆä»…å°± $char$ è¿™ä¸ªå­—ç¬¦å°±æ— æ³•è¢«åŒ¹é…ï¼Œå½“ç„¶æ¨¡å¼å­—ç¬¦ä¸² $pat$ ä¹Ÿå°±ä¸ä¼šè¢«åŒ¹é…ã€‚

å› æ­¤é™¤é $char$ å­—ç¬¦å¯ä»¥å’Œ $pat$ æœ«å°¾çš„é‚£ä¸ªå­—ç¬¦åŒ¹é…ï¼Œå¦åˆ™ $string$ è¦è·³è¿‡ $delta_1$ ä¸ªå­—ç¬¦ï¼ˆç›¸å½“äº $pat$ å‘åæ»‘åŠ¨äº† $delta_1$ ä¸ªå­—ç¬¦ï¼‰ã€‚å¹¶ä¸”æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªè®¡ç®— $delta_1$ çš„å‡½æ•° $delta_1(char)$ï¼š

$$
\begin{array}{ll}
\textbf{int}\ delta1(\textbf{char}\ char) \\
\qquad \textbf{if}\ \text{charä¸åœ¨patä¸­ || charæ˜¯patä¸Šæœ€åä¸€ä¸ªå­—ç¬¦} \\
\qquad\qquad\textbf{return}\ patlen \\
\qquad \textbf{else} \\
\qquad\qquad\textbf{return}\ patlastpos-i\quad\textbf{//}\ \text{iä¸ºå‡ºç°åœ¨patæœ€æœ«å°¾çš„é‚£ä¸€ä¸ªcharå‡ºç°çš„ä½ç½®ï¼Œå³pat[i]=char}
\end{array}
$$

**æ³¨æ„ï¼šæ˜¾ç„¶è¿™ä¸ªè¡¨åªéœ€è®¡ç®—åˆ° $patlastpos-1$ çš„ä½ç½®**

ç°åœ¨å‡è®¾ $char$ å’Œ $pat$ æœ€åä¸€ä¸ªå­—ç¬¦åŒ¹é…åˆ°äº†ï¼Œé‚£æˆ‘ä»¬å°±çœ‹çœ‹ $char$ å‰ä¸€ä¸ªå­—ç¬¦å’Œ $pat$ çš„å€’æ•°ç¬¬äºŒä¸ªå­—ç¬¦æ˜¯å¦åŒ¹é…ï¼š

å¦‚æœæ˜¯ï¼Œå°±ç»§ç»­å›é€€ç›´åˆ°æ•´ä¸ªæ¨¡å¼ä¸² $pat$ å®ŒæˆåŒ¹é…ï¼ˆè¿™æ—¶æˆ‘ä»¬å°±åœ¨ $string$ ä¸ŠæˆåŠŸå¾—åˆ°äº†ä¸€ä¸ª $pat$ çš„åŒ¹é…ï¼‰ï¼›

æˆ–è€…ï¼Œæˆ‘ä»¬ä¹Ÿå¯èƒ½ä¼šåœ¨åŒ¹é…å®Œ $pat$ çš„å€’æ•°ç¬¬ $m$ ä¸ªå­—ç¬¦åï¼Œåœ¨å€’æ•°ç¬¬ $m+1$ ä¸ªå­—ç¬¦ä¸Šå¤±é…ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¸Œæœ›æŠŠ $pat$ å‘åæ»‘åŠ¨åˆ°ä¸‹ä¸€ä¸ªå¯èƒ½ä¼šå®ç°åŒ¹é…çš„ä½ç½®ï¼Œå½“ç„¶æˆ‘ä»¬å¸Œæœ›æ»‘åŠ¨å¾—è¶Šè¿œè¶Šå¥½ã€‚

**è§‚å¯Ÿ 3(a)**ï¼š

åœ¨ **è§‚å¯Ÿ 2** ä¸­æåˆ°ï¼Œå½“åŒ¹é…å®Œ $pat$ çš„å€’æ•° $m$ ä¸ªå­—ç¬¦åï¼Œå¦‚æœåœ¨å€’æ•°ç¬¬ $m+1$ ä¸ªå­—ç¬¦å¤±é…ï¼Œä¸ºäº†ä½¿å¾— $string$ ä¸­çš„å¤±é…å­—ç¬¦ä¸ $pat$ ä¸Šå¯¹åº”å­—ç¬¦å¯¹é½ï¼Œ

éœ€è¦æŠŠ $pat$ å‘åæ»‘åŠ¨ $k$ ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åº”è¯¥æŠŠæ³¨æ„åŠ›çœ‹å‘ä¹‹åçš„ $k+m$ ä¸ªå­—ç¬¦ï¼ˆä¹Ÿå°±æ˜¯çœ‹å‘ $pat$ æ»‘åŠ¨ k ä¹‹åï¼Œæœ«æ®µä¸ $string$ å¯¹é½çš„é‚£ä¸ªå­—ç¬¦ï¼‰ã€‚

è€Œ $k=delta_1-m$ï¼Œ

æ‰€ä»¥æˆ‘ä»¬çš„æ³¨æ„åŠ›åº”è¯¥æ²¿ç€ $string$ å‘åè·³ $delta_1-m+m = delta_1$ ä¸ªå­—ç¬¦ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬æœ‰æœºä¼šè·³è¿‡æ›´å¤šçš„å­—ç¬¦ï¼Œè¯·ç»§ç»­çœ‹ä¸‹å»ã€‚

**è§‚å¯Ÿ 3(b)**ï¼š

å¦‚æœæˆ‘ä»¬çŸ¥é“ $string$ æ¥ä¸‹æ¥çš„ $m$ ä¸ªå­—ç¬¦å’Œ $pat$ çš„æœ€å $m$ ä¸ªå­—ç¬¦åŒ¹é…ï¼Œå‡è®¾è¿™ä¸ªå­ä¸²ä¸º $subpat$ï¼Œ

æˆ‘ä»¬è¿˜çŸ¥é“åœ¨ $string$ å¤±é…å­—ç¬¦ $char$ åé¢æ˜¯ä¸ $subpat$ ç›¸åŒ¹é…çš„å­ä¸²ï¼Œè€Œå‡å¦‚ $pat$ å¯¹åº”å¤±é…å­—ç¬¦å‰é¢å­˜åœ¨ $subpat$ï¼Œæˆ‘ä»¬å¯ä»¥å°† $pat$ å‘ä¸‹æ»‘åŠ¨ä¸€æ®µè·ç¦»ï¼Œ

ä½¿å¾—å¤±é…å­—ç¬¦ $char$ åœ¨ $pat$ ä¸Šå¯¹åº”çš„å­—ç¬¦å‰é¢å‡ºç°çš„ $subpat$ï¼ˆåˆç†é‡ç°ï¼Œplausible reoccurrenceï¼Œä»¥ä¸‹ä¹Ÿç®€ç§° prï¼‰ä¸ $string$ çš„ $subpat$ å¯¹é½ã€‚å¦‚æœ $pat$ ä¸Šæœ‰å¤šä¸ª $subpat$ï¼ŒæŒ‰ç…§ä»å³åˆ°å·¦çš„åç¼€åŒ¹é…é¡ºåºï¼Œå–ç¬¬ä¸€ä¸ªï¼ˆrightmost plausible reoccurrenceï¼Œä»¥ä¸‹ä¹Ÿç®€ç§° rprï¼‰ã€‚

å‡è®¾æ­¤æ—¶ $pat$ å‘ä¸‹æ»‘åŠ¨çš„ $k$ ä¸ªå­—ç¬¦ï¼ˆä¹Ÿå³ $pat$ æœ«å°¾ç«¯çš„ $subpat$ ä¸å…¶æœ€å³è¾¹çš„åˆç†é‡ç°çš„è·ç¦»ï¼‰ï¼Œè¿™æ ·æˆ‘ä»¬çš„æ³¨æ„åŠ›åº”è¯¥æ²¿ç€ $string$ å‘åæ»‘åŠ¨ $k+m$ ä¸ªå­—ç¬¦ï¼Œè¿™æ®µè·ç¦»æˆ‘ä»¬ç§°ä¹‹ä¸º $delta_2(j)$ï¼š

å‡å®š $rpr(j)$ ä¸º $subpat=pat[j+1\dots patlastpos]$ åœ¨ $pat[j]$ ä¸Šå¤±é…æ—¶çš„æœ€å³è¾¹åˆç†é‡ç°çš„ä½ç½®ï¼Œ$rpr(j) < j$ï¼ˆè¿™é‡Œåªç»™å‡ºç®€å•å®šä¹‰ï¼Œåœ¨ä¸‹æ–‡çš„ç®—æ³•è®¾è®¡ç« èŠ‚é‡Œä¼šæœ‰æ›´ç²¾ç¡®çš„è®¨è®ºï¼‰ï¼Œé‚£ä¹ˆæ˜¾ç„¶ $k=j-rpr(j),\ m=patlastpos-j$ã€‚

æ‰€ä»¥æœ‰ï¼š

$$
\begin{array}{ll}
\textbf{int}\ delta2(\textbf{int}\ j) \quad\textbf{//}\ \text{jä¸ºå¤±é…å­—ç¬¦åœ¨patä¸Šå¯¹åº”å­—ç¬¦çš„ä½ç½®} \\
\qquad\qquad\textbf{return}\ patlastpos-rpr(j) \\
\end{array}
$$

äºæ˜¯æˆ‘ä»¬åœ¨å¤±é…æ—¶ï¼Œå¯ä»¥æŠŠæŠŠ $string$ ä¸Šçš„æ³¨æ„åŠ›å¾€åè·³è¿‡ $\max(delta_1,delta_2)$ ä¸ªå­—ç¬¦

## å®ä¾‹è¯´æ˜ï¼š

ç®­å¤´æŒ‡å‘å¤±é…å­—ç¬¦ $char$ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \, \, \Uparrow
\end{aligned}
$$

$\texttt{F}$ æ²¡æœ‰å‡ºç° $pat$ ä¸­ï¼Œæ ¹æ® **è§‚å¯Ÿ 1**ï¼Œ$pat$ ç›´æ¥å‘ä¸‹ç§»åŠ¨ $patlen$ ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ 7 ä¸ªå­—ç¬¦ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\quad\ \ \, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \, \, \qquad\quad\ \ \ \Uparrow
\end{aligned}
$$

æ ¹æ® **è§‚å¯Ÿ 2**ï¼Œæˆ‘ä»¬éœ€è¦å°† $pat$ å‘ä¸‹ç§»åŠ¨ 4 ä¸ªå­—ç¬¦ä½¿å¾—çŸ­æ¨ªçº¿å­—ç¬¦å¯¹é½ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\qquad\quad\ \ \, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \; \qquad\qquad\qquad \Uparrow
\end{aligned}
$$

ç°åœ¨*char*:$\texttt{T}$ åŒ¹é…äº†ï¼ŒæŠŠ $string$ ä¸Šçš„æŒ‡é’ˆå·¦ç§»ä¸€æ­¥ç»§ç»­åŒ¹é…ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\qquad\quad\ \ \, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \; \qquad\qquad\quad\ \, \Uparrow
\end{aligned}
$$

æ ¹æ® **è§‚å¯Ÿ 3(a)**ï¼Œ$\texttt{L}$ å¤±é…ï¼Œå› ä¸º $\texttt{L}$ ä¸åœ¨ $pat$ ä¸­ï¼Œæ‰€ä»¥ $pat$ å‘ä¸‹ç§»åŠ¨ $k=delta_1-m=7-1=6$ ä¸ªå­—ç¬¦ï¼Œè€Œ $string$ ä¸ŠæŒ‡é’ˆå‘ä¸‹ç§»åŠ¨ $delta_1=7$ ä¸ªå­—ç¬¦ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\qquad\qquad\qquad\ \ \,\, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \; \qquad\qquad\qquad\qquad\ \ \ \, \, \Uparrow
\end{aligned}
$$

è¿™æ—¶ $char$ åˆä¸€æ¬¡åŒ¹é…åˆ°äº† $pat$ çš„æœ€åä¸€ä¸ªå­—ç¬¦ $\texttt{T}$ï¼Œ$string$ ä¸Šçš„æŒ‡é’ˆå‘å·¦åŒ¹é…ï¼ŒåŒ¹é…åˆ°äº† $\texttt{A}$ï¼Œç»§ç»­å‘å·¦åŒ¹é…ï¼Œå‘ç°åœ¨å­—ç¬¦ $\texttt{-}$ å¤±é…ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\qquad\qquad\qquad\ \ \,\, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \; \qquad\qquad\qquad\quad\ \ \ \,\, \Uparrow
\end{aligned}
$$

æ˜¾ç„¶ç›´è§‚ä¸Šçœ‹ï¼Œæ­¤æ—¶æ ¹æ® **è§‚å¯Ÿ 3(b)**ï¼Œå°† $pat$ å‘ä¸‹ç§»åŠ¨ $k=5$ ä¸ªå­—ç¬¦ï¼Œä½¿å¾—åç¼€ $\texttt{AT}$ å¯¹é½ï¼Œè¿™ç§æ»‘åŠ¨å¯ä»¥è·å¾— $string$ æŒ‡é’ˆæœ€å¤§çš„æ»‘åŠ¨è·ç¦»ï¼Œæ­¤æ—¶ $delta_2=k+patlastpos-j=5+6-4=7$ï¼Œå³ $string$ ä¸ŠæŒ‡é’ˆå‘ä¸‹æ»‘åŠ¨ 7 ä¸ªå­—ç¬¦ã€‚

è€Œä»å½¢å¼åŒ–é€»è¾‘çœ‹ï¼Œæ­¤æ—¶ï¼Œ$delta_1=7-1-2=4,\ delta_2=7, \max(delta_1,delta_2)= 7$ï¼Œ
è¿™æ ·ä»å½¢å¼é€»è¾‘ä¸Šæ”¯æŒäº†è¿›è¡Œ **è§‚å¯Ÿ 3(b)** çš„è·³è½¬ï¼š

$$
\begin{aligned}
\textit{pat}:\qquad\qquad &\qquad\qquad\qquad\qquad\qquad\quad \;\, \texttt{AT-THAT} \\
\textit{string}:\ \ \ \dots\ &\texttt{WHICH-FINALLY-HALTS.--AT-THAT-POINT} \dots \\
&\qquad\ \ \ \; \qquad\qquad\qquad\qquad\qquad\quad \ \ \; \Uparrow
\end{aligned}
$$

ç°åœ¨æˆ‘ä»¬å‘ç°äº† $pat$ ä¸Šæ¯ä¸€ä¸ªå­—ç¬¦éƒ½å’Œ $string$ ä¸Šå¯¹åº”çš„å­—ç¬¦ç›¸ç­‰ï¼Œæˆ‘ä»¬åœ¨ $string$ ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ª $pat$ çš„åŒ¹é…ã€‚è€Œæˆ‘ä»¬åªèŠ±è´¹äº† 14 æ¬¡å¯¹ $string$ çš„å¼•ç”¨ï¼Œå…¶ä¸­ 7 æ¬¡æ˜¯å®Œæˆä¸€ä¸ªæˆåŠŸçš„åŒ¹é…æ‰€å¿…éœ€çš„æ¯”è¾ƒæ¬¡æ•°ï¼ˆ$patlen=7$ï¼‰ï¼Œå¦å¤– 7 æ¬¡è®©æˆ‘ä»¬è·³è¿‡äº† 22 ä¸ªå­—ç¬¦ï¼ŒAmazingï¼ˆæµ®å¤¸å£æ°”ï¼‰ï¼

## ç®—æ³•è®¾è®¡

### æœ€åˆçš„åŒ¹é…ç®—æ³•

ç°åœ¨çœ‹è¿™æ ·ä¸€ä¸ªåˆ©ç”¨ $delta_1$ å’Œ $delta_2$ è¿›è¡Œå­—ç¬¦ä¸²åŒ¹é…çš„ç®—æ³•ï¼š

$$
\begin{array}{ll}
i \gets patlastpos. \\
j \gets patlastpos. \\
\textbf{loop}\\
\qquad \textbf{if}\ j < 0 \\
\qquad \qquad \textbf{return}\ i+1 \\
\\
\qquad \textbf{if}\ string[i]=pat[j] \\
\qquad \qquad j \gets j-1 \\
\qquad \qquad i \gets i-1 \\
\qquad \qquad \textbf{continue} \\
\\
\qquad i \gets i+max(delta_1(string[i]), delta_2(j)) \\
\\
\qquad \textbf{if}\ i > stringlastpos \\
\qquad \qquad \textbf{return}\ false \\
\qquad j \gets patlastpos \\
\end{array}
$$

å¦‚æœä¸Šé¢çš„ç®—æ³• $\textbf{return}\ false$ï¼Œè¡¨æ˜ $pat$ ä¸åœ¨ $string$ ä¸­ï¼›å¦‚æœè¿”å›ä¸€ä¸ªæ•°å­—ï¼Œè¡¨ç¤º $pat$ åœ¨ $string$ å·¦èµ·ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®ã€‚

ç„¶åè®©æˆ‘ä»¬æ›´ç²¾ç»†åœ°æè¿°ä¸‹è®¡ç®— $delta_2$ï¼Œæ‰€ä¾é çš„ $rpr(j)$ å‡½æ•°ã€‚

æ ¹æ®å‰æ–‡å®šä¹‰ï¼Œ$rpr(j)$ è¡¨ç¤ºåœ¨ $pat(j)$ å¤±é…æ—¶ï¼Œå­ä¸² $subpat=pat[j+1\dots patlastpos]$ åœ¨ $pat[j]$ æœ€å³è¾¹åˆç†é‡ç°çš„ä½ç½®ã€‚

ä¹Ÿå°±æ˜¯è¯´éœ€è¦æ‰¾åˆ°ä¸€ä¸ªæœ€å¥½çš„ $k$, ä½¿å¾— $pat[k\dots k+patlastpos-j-1]=pat[j+1\dots patlastpos]$ï¼Œå¦å¤–è¦è€ƒè™‘ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼š

1. å½“ $k<0$ æ—¶ï¼Œç›¸å½“äºåœ¨ $pat$ å‰é¢è¡¥å……äº†ä¸€æ®µè™šæ‹Ÿçš„å‰ç¼€ï¼Œå®é™…ä¸Šä¹Ÿç¬¦åˆ $delta_2$ è·³è½¬çš„åŸç†ã€‚
2.  å½“ $k>0$ æ—¶ï¼Œå¦‚æœ $pat[k-1]=pat[j]$ï¼Œåˆ™è¿™ä¸ª $pat[k\dots k+patlastpos-j-1]$ ä¸èƒ½ä½œä¸º $subpat$ çš„åˆç†é‡ç°ã€‚
    åŸå› æ˜¯ $pat[j]$ æœ¬èº«æ˜¯å¤±é…å­—ç¬¦ï¼Œæ‰€ä»¥ $pat$ å‘ä¸‹æ»‘åŠ¨ $k$ ä¸ªå­—ç¬¦åï¼Œåœ¨åç¼€åŒ¹é…è¿‡ç¨‹ä¸­ä»ç„¶ä¼šåœ¨ $pat[k-1]$ å¤„å¤±é…ã€‚

è¿˜è¦æ³¨æ„ä¸¤ä¸ªé™åˆ¶æ¡ä»¶ï¼š

1. $k < j$ã€‚å› ä¸ºå½“ $k=j$ æ—¶ï¼Œæœ‰ $pat[k]=pat[j]$ï¼Œåœ¨ $pat[j]$ ä¸Šå¤±é…çš„å­—ç¬¦ä¹Ÿä¼šåœ¨ $pat[k]$ ä¸Šå¤±é…ã€‚
2. è€ƒè™‘åˆ° $delta_2(patlastpos)= 0$ï¼Œæ‰€ä»¥è§„å®š $rpr(patlastpos) = patlastpos$ã€‚

ç”±äºç†è§£ $rpr(j)$ æ˜¯å®ç° BoyerMoore ç®—æ³•çš„æ ¸å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ä¸¤ä¸ªä¾‹å­è¿›è¡Œè¯¦ç»†è¯´æ˜ï¼š

$$
\begin{aligned}
\textit{j}:\qquad\qquad\quad\ \ &\texttt{0 1 2 3 4 5 6 7 8} \\
\textit{pat}:\qquad\qquad\ \  &\texttt{A B C X X X A B C} \\
\textit{rpr(j)}:\qquad\quad\  \  &\texttt{5 4 3 2 1 0 2 1 8} \\
\textit{sgn}:\qquad\qquad\ \   &\texttt{- - - - - - - - +}
\end{aligned}
$$

å¯¹äº $rpr(0)$ï¼Œ$subpat$ ä¸º $\texttt{BCXXXABC}$ï¼Œåœ¨ $pat[0]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(BCXXX)ABC]XXXABC}$ï¼Œä¹Ÿå°±æ˜¯æœ€å³è¾¹åˆç†é‡ç°ä½ç½®ä¸º -5ï¼Œå³ $rpr(j)=-5$ï¼›

å¯¹äº $rpr(1)$ï¼Œ$subpat$ ä¸º $\texttt{CXXXABC}$ï¼Œåœ¨ $pat[1]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(CXXX)ABC]XXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-4$ï¼›

å¯¹äº $rpr(2)$ï¼Œ$subpat$ ä¸º $\texttt{XXXABC}$ï¼Œåœ¨ $pat[2]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(XXX)ABC]XXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-3$ï¼›

å¯¹äº $rpr(3)$ï¼Œ$subpat$ ä¸º $\texttt{XXABC}$ï¼Œåœ¨ $pat[3]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(XX)ABC]XXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-2$ï¼›

å¯¹äº $rpr(4)$ï¼Œ$subpat$ ä¸º $\texttt{XABC}$ï¼Œåœ¨ $pat[4]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(X)ABC]XXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-1$ï¼›

å¯¹äº $rpr(5)$ï¼Œ$subpat$ ä¸º $\texttt{ABC}$ï¼Œåœ¨ $pat[5]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[ABC]XXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=0$ï¼›

å¯¹äº $rpr(6)$ï¼Œ$subpat$ ä¸º $\texttt{BC}$ï¼Œåˆå› ä¸º $string[0]=string[6]$ï¼Œå³ $string[0]$ ç­‰äºå¤±é…å­—ç¬¦ $string[6]$ï¼Œæ‰€ä»¥ $string[0\dots 2]$ å¹¶ä¸æ˜¯ç¬¦åˆæ¡ä»¶çš„ $subpat$ çš„åˆç†é‡ç°ï¼Œæ‰€ä»¥åœ¨æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(BC)]ABCXXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-2$ï¼›

å¯¹äº $rpr(7)$ï¼Œ$subpat$ ä¸º $\texttt{C}$ï¼ŒåŒç†åˆå› ä¸º $string[7]=string[1]$ï¼Œæ‰€ä»¥ $string[1\dots 2]$ å¹¶ä¸æ˜¯ç¬¦åˆæ¡ä»¶çš„ $subpat$ çš„åˆç†é‡ç°ï¼Œåœ¨æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[(C)]ABCXXXABC}$ï¼Œæ‰€ä»¥ $rpr(j)=-1$ï¼›

å¯¹äº $rpr(8)$ï¼Œæ ¹æ® $delta_2$ å®šä¹‰ï¼Œ$rpr(patlastpos)=patlastpos$ï¼Œå¾—åˆ° $rpr(8)=8$ã€‚

ç°åœ¨å†çœ‹ä¸€ä¸‹å¦ä¸€ä¸ªä¾‹å­ï¼š

$$
\begin{aligned}
\textit{j}:\qquad\qquad\quad\ \ &\texttt{0 1 2 3 4 5 6 7 8} \\
\textit{pat}:\qquad\qquad\ \ &\texttt{A B Y X C D E Y X} \\
\textit{rpr(j)}:\qquad\quad\  \  &\texttt{8 7 6 5 4 3 2 1 8} \\
\textit{sgn}:\qquad\qquad\ \   &\texttt{- - - - - - + - +}
\end{aligned}
$$

å¯¹äº $rpr(0)$ï¼Œ$subpat$ ä¸º $\texttt{BYXCDEYX}$ï¼Œåœ¨ $pat[0]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(BYXCDEYX)]ABYXCDEYX}$ï¼Œä¹Ÿå°±æ˜¯æœ€å³è¾¹åˆç†é‡ç°ä½ç½®ä¸º -8ï¼Œå³ $rpr(j)=-8$ï¼›

å¯¹äº $rpr(1)$ï¼Œ$subpat$ ä¸º $\texttt{YXCDEYX}$ï¼Œåœ¨ $pat[1]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(YXCDEYX)]ABYXCDEYX}$ï¼Œ$rpr(j)=-7$ï¼›

å¯¹äº $rpr(2)$ï¼Œ$subpat$ ä¸º $\texttt{XCDEYX}$ï¼Œåœ¨ $pat[2]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(XCDEYX)]ABYXCDEYX}$ï¼Œ$rpr(j)=-6$ï¼›

å¯¹äº $rpr(3)$ï¼Œ$subpat$ ä¸º $\texttt{CDEYX}$ï¼Œåœ¨ $pat[3]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(CDEYX)]ABYXCDEYX}$ï¼Œ$rpr(j)=-5$ï¼›

å¯¹äº $rpr(4)$ï¼Œ$subpat$ ä¸º $\texttt{DEYX}$ï¼Œåœ¨ $pat[4]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(DEYX)]ABYXCDEYX}$ï¼Œ$rpr(j)=-4$ï¼›

å¯¹äº $rpr(5)$ï¼Œ$subpat$ ä¸º $\texttt{EYX}$ï¼Œåœ¨ $pat[5]$ ä¹‹å‰çš„æœ€å³è¾¹åˆç†é‡ç°åªèƒ½æ˜¯ $\texttt{[(EYX)]ABYXCDEYX}$ï¼Œ$rpr(j)=-3$ï¼›

å¯¹äº $rpr(6)$ï¼Œ$subpat$ ä¸º $\texttt{YX}$ï¼Œå› ä¸º $string[2\dots 3]=string[7\dots 8]$ å¹¶ä¸”æœ‰ $string[6]\neq string[1]$ï¼Œæ‰€ä»¥åœ¨ $pat[6]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{AB[YX]CDEYX}$ï¼Œ$rpr(j)=2$ï¼›

å¯¹äº $rpr(7)$ï¼Œ$subpat$ ä¸º $\texttt{X}$ï¼Œè™½ç„¶ $string[3]=string[8]$ ä½†æ˜¯å› ä¸º $string[2] = string[7]$ï¼Œæ‰€ä»¥åœ¨ $pat[7]$ ä¹‹å‰çš„æœ€å³è¾¹çš„åˆç†é‡ç°æ˜¯ $\texttt{[X]ABYXCDEYX}$ï¼Œ$rpr(j)=-1$;

å¯¹äº $rpr(8)$ï¼Œæ ¹æ® $delta_2$ å®šä¹‰ï¼Œ$rpr(patlastpos)=patlastpos$ï¼Œå¾—åˆ° $rpr(8)=8$ã€‚

### å¯¹åŒ¹é…ç®—æ³•çš„ä¸€ä¸ªæ”¹è¿›

æœ€åï¼Œå®è·µè¿‡ç¨‹ä¸­è€ƒè™‘åˆ°æœç´¢è¿‡ç¨‹ä¸­ä¼°è®¡æœ‰ 80% çš„æ—¶é—´ç”¨åœ¨äº†åŸºäº **è§‚å¯Ÿ 1** çš„è·³è½¬ä¸Šï¼Œä¹Ÿå°±æ˜¯ $string[i]$ å’Œ $pat[patlastpos]$ ä¸åŒ¹é…ï¼Œç„¶åè·³è¶Šæ•´ä¸ª $patlen$ è¿›è¡Œä¸‹ä¸€æ¬¡åŒ¹é…çš„è¿‡ç¨‹ã€‚

äºæ˜¯ï¼Œå¯ä»¥ä¸ºæ­¤è¿›è¡Œç‰¹åˆ«çš„ä¼˜åŒ–ï¼š

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª $delta0$ï¼š

$$
\begin{array}{ll}
\textbf{int}\ delta0(\textbf{char}\ char) \\
\qquad \textbf{if}\ char=pat[patlastpos] \\
\qquad\qquad \textbf{return}\ large\ \ \text{// largeä¸ºä¸€ä¸ªæ•´æ•°ï¼Œéœ€è¦æ»¡è¶³large>stringlastpos+patlen} \\
\qquad \textbf{return}\ delta1(char)
\end{array}
$$

ç”¨ $delta0$ ä»£æ›¿ $delta_1$ï¼Œå¾—åˆ°æ”¹è¿›åçš„åŒ¹é…ç®—æ³•ï¼š

$$
\begin{array}{ll}
i \gets patlastpos \\
\textbf{loop} \\
\qquad\textbf{if} \ i > stringlastpos \\
\qquad\qquad\textbf{return}\ false\\
\\
\qquad\textbf{while}\ i < stringlen \\
\qquad\qquad i \gets i+delta0(string(i)) \ \ \text{// é™¤éstring[i]å’Œpatæœ«å°¾å­—ç¬¦åŒ¹é…ï¼Œå¦åˆ™è‡³å¤šå‘ä¸‹æ»‘åŠ¨patlen }\\\
\qquad\textbf{if}\ i \leqslant\ large \qquad\qquad\qquad\qquad \text{//æ­¤æ—¶è¡¨ç¤ºstringä¸Šæ²¡æœ‰ä¸€ä¸ªå­—ç¬¦å’Œpatæœ«å°¾å­—ç¬¦åŒ¹é…}\ \\
\qquad\qquad\textbf{return}\ false\\
\\
\qquad i \gets i-large \\
\qquad j \gets patlastpos. \\
\qquad\textbf{while}\ j \geqslant\ 0 \ and \  string[i]=pat[j]\\
\qquad \qquad j \gets j-1 \\
\qquad \qquad i \gets i-1 \\
\\
\qquad \textbf{if}\ j < 0 \\
\qquad \qquad \textbf{return}\ i+1 \\
\qquad i \gets i+max(delta_1(string[i]), delta_2(j)) \\
\\
\end{array}
$$

å…¶ä¸­ $large$ èµ·åˆ°å¤šé‡ä½œç”¨ï¼Œä¸€æ˜¯ç±»ä¼¼åé¢ä»‹ç»çš„ Horspool ç®—æ³•è¿›è¡Œå¿«é€Ÿçš„åå­—ç¬¦è·³è½¬ï¼ŒäºŒæ˜¯è¾…åŠ©æ£€æµ‹å­—ç¬¦ä¸²æœç´¢æ˜¯å¦å®Œæˆã€‚

ç»è¿‡æ”¹è¿›ï¼Œæ¯”èµ·åŸç®—æ³•ï¼Œåœ¨åš **è§‚å¯Ÿ 1** è·³è½¬æ—¶ä¸å¿…æ¯æ¬¡è¿›è¡Œ $delta_2$ çš„å¤šä½™è®¡ç®—ï¼Œä½¿å¾—åœ¨é€šå¸¸å­—ç¬¦é›†ä¸‹æœç´¢å­—ç¬¦ä¸²çš„æ€§èƒ½æœ‰äº†æ˜æ˜¾çš„æå‡ã€‚

## $delta_2$ æ„å»ºç»†èŠ‚

### å†å²ç»†èŠ‚

è¯´èµ· $delta_2$ çš„å®ç°ï¼Œå‘è¡¨åœ¨ 1977 å¹´ 10 æœˆçš„*Communications of the ACM*ä¸Šçš„åœ¨ Boyerã€Moor çš„è®ºæ–‡[^bm]é‡Œåªæè¿°äº†è¿™ä¸ªé™æ€è¡¨ï¼Œå¹¶æ²¡æœ‰è¯´æ˜å¦‚ä½•äº§ç”Ÿå®ƒã€‚

è€Œæ„é€  $delta_2$ çš„å…·ä½“å®ç°çš„è®¨è®ºå‡ºç°åœ¨ 1977 å¹´ 6 æœˆ Knuthã€Morrisã€Pratt åœ¨*SIAM Journal on Computing*ä¸Šæ­£å¼è”åˆå‘è¡¨çš„ KMP ç®—æ³•çš„è®ºæ–‡[^kmp]é‡Œï¼ˆè¿™ç¯‡è®ºæ–‡æ˜¯ä¸ªå®è—ï¼Œé™¤äº† KMPï¼Œå…¶ä¸­è¿˜æåŠäº†è‹¥å¹²å­—ç¬¦ä¸²æœç´¢çš„ç®—æ³•æ„æƒ³å’Œä»‹ç»ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†æœ¬æ–‡ä»‹ç»çš„ BM ç®—æ³•ï¼‰ï¼Œå¬åŠ›æ¥æœ‰ç‚¹å„¿é­”å¹»ï¼Œå—¯å“¼ï¼Ÿè¿™å°±ä¸å¾—ä¸ç¨å¾®ä»‹ç»ä¸€ç‚¹å†å²ç»†èŠ‚äº†ï¼š

1. 1969 å¹´å¤å¤© Morris ä¸ºæŸä¸ªå¤§å‹æœºç¼–å†™æ–‡æœ¬ç¼–è¾‘å™¨æ—¶åˆ©ç”¨æœ‰é™è‡ªåŠ¨æœºçš„ç†è®ºå‘æ˜äº†ç­‰ä»·äº KMP ç®—æ³•çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼Œè€Œä»–çš„ç®—æ³•ç”±äºè¿‡äºå¤æ‚ï¼Œè¢«ä¸ç†è§£ä»–ç®—æ³•çš„åŒäº‹å½“åš bug ä¿®æ”¹å¾—ä¸€å›¢ç³Ÿï¼Œå“ˆå“ˆã€‚

2. 1970 å¹´ KMP ä¸­çš„â€œå¸¦å¤´äººâ€Knuth åœ¨ç ”ç©¶ Cook çš„å…³äºä¸¤è·¯ç¡®å®šä¸‹æ¨è‡ªåŠ¨æœºï¼ˆtwo-way deterministic pushdown automatonï¼‰çš„ç†è®ºæ—¶å—åˆ°å¯å‘ï¼Œä¹Ÿç‹¬ç«‹å‘æ˜äº† KMP ç®—æ³•çš„é›å½¢ï¼Œå¹¶æŠŠå®ƒå±•ç¤ºç»™ä»–çš„åŒäº‹ Prattï¼ŒPratt æ”¹è¿›äº†ç®—æ³•çš„æ•°æ®ç»“æ„ã€‚

3. 1974 å¹´ Boyerã€Moor å‘ç°é€šè¿‡æ›´å¿«åœ°è·³è¿‡ä¸å¯èƒ½åŒ¹é…çš„æ–‡æœ¬èƒ½å®ç°æ¯” KMP æ›´å¿«çš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œï¼ˆGosper ä¹Ÿç‹¬ç«‹åœ°å‘ç°äº†è¿™ä¸€ç‚¹ï¼‰ï¼Œè€Œä¸€ä¸ªåªæœ‰åŸå§‹ $delta_1$ å®šä¹‰çš„åŒ¹é…ç®—æ³•æ˜¯ BM ç®—æ³•çš„æœ€åŸå§‹ç‰ˆæœ¬ã€‚

4. 1975 å¹´ Boyerã€Moor æå‡ºäº†åŸå§‹çš„ $delta_2$ è¡¨ï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬çš„ $delta_2$ è¡¨ä¸ä»…ä¸ä¼šå¯¹æ€§èƒ½æœ‰æ‰€æ”¹å–„ï¼Œè¿˜ä¼šåœ¨å¤„ç†å°å­—ç¬¦è¡¨æ—¶æ‹–ç´¯æ€§èƒ½è¡¨ç°ï¼Œè€ŒåŒå¹´ MIT äººå·¥æ™ºèƒ½å®éªŒå®¤çš„ Kuipers å’Œæˆ‘ä»¬ç†Ÿæ‚‰çš„ Knuth å‘ä»–ä»¬æå‡ºäº†ç±»ä¼¼çš„å…³äº $delta_2$ çš„æ”¹è¿›å»ºè®®ï¼Œäºæ˜¯ Boyerã€Moor åœ¨è®ºæ–‡çš„ä¸‹ä¸€æ¬¡ä¿®æ”¹ä¸­æåˆ°äº†è¿™ä¸ªå»ºè®®ï¼Œå¹¶æå‡ºä¸€ä¸ªç”¨äºŒç»´è¡¨ä»£æ›¿ $delta_1$ å’Œ $delta_2$ çš„æƒ³æ³•ã€‚

5. 1976 å¹´ 1 æœˆ Knuth è¯æ˜äº†å…³äº $delta_2$ çš„æ”¹è¿›ä¼šå¾—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œäºæ˜¯ Boyerã€Moor ä¸¤äººåˆä¸€æ¬¡ä¿®æ”¹äº†è®ºæ–‡ï¼Œå¾—åˆ°äº†ç°åœ¨ç‰ˆæœ¬çš„ $delta_2$ å®šä¹‰ã€‚åŒå¹´ 4 æœˆï¼Œæ–¯å¦ç¦çš„ Floyd åˆå‘ç°äº† Boyerã€Moor ä¸¤äººç¬¬ä¸€ç‰ˆæœ¬çš„å…¬å¼ä¸­çš„ä¸¥é‡çš„ç»Ÿè®¡é”™è¯¯ï¼Œå¹¶ç»™å‡ºäº†ç°åœ¨ç‰ˆæœ¬çš„å…¬å¼ã€‚

6. Standish åˆä¸º Boyerã€Moor æä¾›äº†ç°åœ¨çš„åŒ¹é…ç®—æ³•çš„æ”¹è¿›ã€‚

7. 1977 å¹´ 6 æœˆ Knuthã€Morrisã€Pratt æ­£å¼è”åˆå‘è¡¨äº† KMP ç®—æ³•çš„è®ºæ–‡ï¼Œå…¶ä¸­åœ¨æåŠæ¯” KMP è¡¨ç°æ›´å¥½çš„ç®—æ³•ä¸­æå‡ºäº† $delta_2$ çš„æ„å»ºæ–¹å¼ã€‚ï¼ˆå…¶ä¸­ä¹Ÿæ„Ÿè°¢äº† Boyerã€Moor å¯¹äºè¯æ˜çº¿æ€§å®šç†ï¼ˆlinearity theoremï¼‰æä¾›çš„å¸®åŠ©ï¼‰

è¿™ä¸ª BM ç®—æ³•çš„å‘å±•çš„æ•…äº‹ï¼Œåˆ‡å®åœ°å‘æˆ‘ä»¬å±•ç¤ºäº†å›¢ç»“ã€å‹è°Šã€åä½œï¼Œä»¥åŠè°¦è™šå¥½å­¦ä¸æŠ˜ä¸æŒ â€œåœ¨å¹³å‡¡ä¸­å®ç°ä¼Ÿå¤§â€ï¼ğŸ˜‚ğŸ˜‚ğŸ˜‚

### æ—¶é—´å¤æ‚åº¦ä¸º $O(n^3)$ çš„æ„å»º $delta_2$ çš„æœ´ç´ ç®—æ³•

åœ¨ä»‹ç» Knuth çš„ $delta_2$ æ„å»ºç®—æ³•ä¹‹å‰ï¼Œæ ¹æ®å®šä¹‰ï¼Œæˆ‘ä»¬ä¼šæœ‰ä¸€ä¸ªåŸå§‹ã€ç®€å•ä½†æœ‰æ—¶å¯èƒ½å·²ç»å¤Ÿç”¨çš„æœ´ç´ ç®—æ³•ï¼ˆé™¤éä½ éœ€è¦æ„å»ºé•¿åº¦æˆç™¾ä¸Šåƒçš„ $pat$ï¼‰ï¼š

1. å¯¹äº `[0, patlen)` åŒºé—´çš„æ¯ä¸€ä¸ªä½ç½® `i`ï¼Œæ ¹æ® `subpat` çš„é•¿åº¦ç¡®å®šå…¶é‡ç°ä½ç½®çš„åŒºé—´ï¼Œä¹Ÿå°±æ˜¯ `[-subpatlen, i]`ï¼›
2. å¯èƒ½çš„é‡ç°ä½ç½®æŒ‰ç…§ä»å³åˆ°å·¦è¿›è¡Œé€å­—ç¬¦æ¯”è¾ƒï¼Œå¯»æ‰¾ç¬¦åˆ $delta_2$ è¦æ±‚çš„æœ€å³è¾¹ $subpat$ çš„é‡ç°ä½ç½®ï¼›
3. æœ€ååˆ«å¿˜äº†ä»¤ $delta_2(lastpos)= 0$ã€‚

```Rust
use std::cmp::PartialEq;

pub fn build_delta_2_table_naive(p: &[impl PartialEq]) -> Vec<usize> {
    let patlen = p.len();
    let lastpos = patlen - 1;
    let mut delta_2 = vec![];

    for i in 0..patlen {
        let subpatlen = (lastpos - i) as isize;

        if subpatlen == 0 {
            delta_2.push(0);
            break;
        }

        for j in (-subpatlen..(i + 1) as isize).rev() {
            // subpat åŒ¹é…
            if (j..j + subpatlen)
            .zip(i + 1..patlen)
            .all(|(rpr_index, subpat_index)| {
                if rpr_index < 0 {
                    return true;
                }

                if p[rpr_index as usize] == p[subpat_index] {
                    return true;
                }

                false
            })
            && (j <= 0 || p[(j - 1) as usize] != p[i])
            {
                delta_2.push((lastpos as isize - j) as usize);
                break;
            }
        }
    }

    delta_2
}
```

ç‰¹åˆ«åœ°ï¼Œå¯¹ Rust è¯­è¨€ç‰¹æ€§è¿›è¡Œå¿…è¦åœ°è§£é‡Šï¼Œä¸‹ä¸èµ˜è¿°ï¼š

- `usize` å’Œ `isize` æ˜¯å’Œå†…å­˜æŒ‡é’ˆåŒå­—èŠ‚æ•°çš„æ— ç¬¦å·æ•´æ•°å’Œæœ‰ç¬¦å·æ•´æ•°ï¼Œåœ¨ 32 ä½æœºä¸Šç›¸å½“äº `u32` å’Œ `i32`ï¼Œ64 ä½æœºä¸Šç›¸å½“äº `u64` å’Œ `i64`ã€‚
- ç´¢å¼•æ•°ç»„ã€å‘é‡ã€åˆ†ç‰‡æ—¶ä½¿ç”¨ `usize` ç±»å‹çš„æ•°å­—ï¼ˆå› ä¸ºåœ¨åšå†…å­˜ä¸Šçš„éšæœºè®¿é—®å¹¶ä¸”ä¸‹æ ‡ä¸èƒ½ä¸ºè´Ÿå€¼ï¼‰ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦å¤„ç†è´Ÿå€¼è¦ç”¨ `isize`ï¼Œè€Œè¿›è¡Œç´¢å¼•æ—¶åˆè¦ç”¨ `usize`ï¼Œè¿™å°±çœ‹åˆ°ä½¿ç”¨ `as` å…³é”®å­—è¿›è¡ŒäºŒè€…ä¹‹é—´çš„æ˜¾å¼è½¬æ¢ã€‚
- `impl PartialEq` åªæ˜¯ç”¨ä½œæ³›å‹ï¼Œå¯ä»¥åŒæ—¶æ”¯æŒ `Unicode` ç¼–ç çš„ `char` å’ŒäºŒè¿›åˆ¶çš„ `u8`ã€‚

æ˜¾è§è¿™æ˜¯ä¸ªæ—¶é—´å¤æ‚åº¦ä¸º $O(n^3)$ çš„æš´åŠ›ç®—æ³•ã€‚

### æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ çš„æ„å»º $delta_2$ çš„é«˜æ•ˆç®—æ³•

ä¸‹é¢æˆ‘ä»¬è¦ä»‹ç»çš„æ˜¯æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œä½†æ˜¯éœ€è¦é¢å¤– $O(n)$ ç©ºé—´å¤æ‚åº¦çš„é«˜æ•ˆç®—æ³•ã€‚

éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œè™½ç„¶ 1977 å¹´ Knuth æå‡ºäº†è¿™ä¸ªæ„å»ºæ–¹æ³•ï¼Œç„¶è€Œä»–çš„åŸå§‹ç‰ˆæœ¬çš„æ„å»ºç®—æ³•å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼Œå®é™…ä¸Šå¯¹äºæŸäº› $pat$ äº§ç”Ÿä¸å‡ºç¬¦åˆå®šä¹‰çš„ $delta_2$ã€‚

Rytter åœ¨ 1980 å¹´*SIAM Journal on Computing*ä¸Šå‘è¡¨çš„æ–‡ç« [^rytter]å¯¹æ­¤æå‡ºäº†ä¿®æ­£ï¼Œä½†æ˜¯ Rytter çš„è¿™ç¯‡æ–‡ç« åœ¨ç»†èŠ‚ä¸Šæœ‰äº›ä»¤äººç–‘æƒ‘çš„åœ°æ–¹ï¼ŒåŒ…æ‹¬ä¸é™äºï¼š

- ç¤ºä¾‹ä¸­å¥‡æ€ªçš„ $delta_2$ æ•°å€¼ï¼ˆä¸æ¸…æ¥šä»–ä¾æ®çš„ $delta_2$ æ˜¯å¦å’Œæœ€ç»ˆç‰ˆ $delta_2$ å®šä¹‰æœ‰å¾®å¦™çš„å·®åˆ«ï¼Œä½†æˆ‘å®åœ¨ä¸æƒ³å› ä¸ºè¿™äº‹å„¿ç»§ç»­è€ƒå¤äº†ğŸ˜±ï¼‰
- æ˜æ˜¾çš„åœ¨å¤è¿° Knuth ç®—æ³•æ—¶çš„ç¬”è¯¯ã€ç®—æ³•ä¸Šé”™è¯¯çš„ç¼©è¿›ï¼ˆå¯èƒ½æ˜¯æ–‡ç« å½•å…¥æ—¶çš„é—®é¢˜ï¼Ÿï¼‰
- å¥‡å¦™çš„å˜é‡å‘½åï¼ˆè€ƒè™‘åˆ°é‚£ä¸ªæ—¶ä»£çš„æ ‡ç­¾ï¼š`goto` è¯­å¥ã€æ±‡ç¼–è¯­è¨€ã€å¤§å‹æœºï¼Œéšæ€§çš„å˜é‡å‘½åä¹Ÿå¾ˆåˆç†ï¼‰

æ€»ä¹‹å°±æ˜¯ä½ ç»å¯¹ä¸æƒ³çœ‹ä»–çš„é‚£ä¸ªä¿®æ­£ç®—æ³•çš„å…·ä½“å®ç°ï¼Œä¸è¿‡å¥½åœ¨ä»–åœ¨ç”¨æ–‡å­—æè¿°çš„æ—¶å€™æ¯”ç”¨ä¼ªä»£ç æ¸…æ™°å¤šäº†å‘¢ï¼Œç°åœ¨æˆ‘ä»¬ç”¨æ›´æ¸…æ™°çš„æ€è·¯å’Œä»£ç ç»“æ„æ•´ç†è¿™ä¹ˆä¸€ä¸ª

$delta_2$ çš„æ„å»ºç®—æ³•ï¼š

é¦–å…ˆè€ƒè™‘åˆ° $delta_2$ çš„å®šä¹‰æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æŒ‰ç…§ $subpat$ çš„é‡ç°ä½ç½®è¿›è¡Œåˆ†ç±»ï¼Œæ¯ä¸€ç±»è¿›è¡Œå•ç‹¬å¤„ç†ï¼Œè¿™æ˜¯é«˜æ•ˆå®ç°çš„å…³é”®æ€è·¯ã€‚

æŒ‰ç…§é‡ç°ä½ç½®ç”±è¿œåˆ°è¿‘ï¼Œä¹Ÿå°±æ˜¯åç§»é‡ç”±å¤§åˆ°å°ï¼Œåˆ†æˆå¦‚ä¸‹å‡ ç±»ï¼š

1. æ•´ä¸ª $subpat$ é‡ç°ä½ç½®å®Œå…¨åœ¨ $pat$ å·¦è¾¹çš„ï¼Œæ¯”å¦‚ $\texttt{[(EYX)]ABYXCDEYX}$ï¼Œæ­¤æ—¶ $delta_2(j) = patlastpos\times 2 - j$ï¼›

2.  $subpat$ çš„é‡ç°æœ‰ä¸€éƒ¨åˆ†åœ¨ $pat$ å·¦è¾¹ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯ $pat$ å¤´éƒ¨ï¼Œæ¯”å¦‚ $\texttt{[(XX)ABC]XXXABC}$ï¼Œæ­¤æ—¶ $patlastpos < delta_2(j) < patlastpos\times 2 - j$ï¼›
    æˆ‘ä»¬æŠŠ $subpat$ å®Œå…¨åœ¨ $pat$ å¤´éƒ¨çš„çš„è¾¹é™…æƒ…å†µä¹Ÿå½’ç±»åœ¨è¿™é‡Œï¼ˆå½“ç„¶æ ¹æ®å®ç°ä¹Ÿå¯ä»¥å½’ç±»åœ¨ä¸‹è¾¹ï¼‰ï¼Œæ¯”å¦‚ $\texttt{[ABC]XXXABC}$ï¼Œæ­¤æ—¶ $patlastpos = delta_2(j)$ï¼›

3. $subpat$ çš„é‡ç°å®Œå…¨åœ¨ $pat$ ä¸­ï¼Œæ¯”å¦‚ $\texttt{AB[YX]CDEYX}$ï¼Œæ­¤æ—¶ $delta_2(j) < patlastpos$ã€‚

ç°åœ¨æ¥è®¨è®ºå¦‚ä½•é«˜æ•ˆåœ°è®¡ç®—è¿™ä¸‰ç§æƒ…å†µï¼š

#### ç¬¬ä¸€ç§æƒ…å†µ

è¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œåªéœ€ä¸€æ¬¡éå†å¹¶ä¸”å¯ä»¥é¡ºä¾¿å°† $delta_2$ åˆå§‹åŒ–ã€‚

#### ç¬¬äºŒç§æƒ…å†µ

æˆ‘ä»¬è§‚å¯Ÿä»€ä¹ˆæ—¶å€™ä¼šå‡ºç° $subpat$ çš„é‡ç°ä¸€éƒ¨åˆ†åœ¨ $pat$ å·¦è¾¹ï¼Œä¸€éƒ¨åˆ†æ˜¯ $pat$ çš„å¤´éƒ¨çš„æƒ…å†µå‘¢ï¼Ÿåº”è¯¥æ˜¯ $subpat$ çš„æŸä¸ªåç¼€å’Œ $pat$ çš„æŸä¸ªå‰ç¼€ç›¸ç­‰ï¼Œ

æ¯”å¦‚ä¹‹å‰çš„ä¾‹å­ï¼š

$$
\begin{aligned}
\textit{j}:\qquad\qquad\quad\ \ &\texttt{0 1 2 3 4 5 6 7 8} \\
\textit{pat}:\qquad\qquad\ \  &\texttt{A B C X X X A B C} \\
\end{aligned}
$$

$delta_2(3)$ çš„é‡ç° $\texttt{[(XX)ABC]XXXABC}$ï¼Œ$subpat$ $\texttt{XXABC}$ çš„åç¼€ä¸ pat å‰ç¼€ä¸­ï¼Œæœ‰ç›¸ç­‰çš„ï¼Œæ˜¯ $\texttt{ABC}$ã€‚

*è¯´åˆ°è¿™ä¸ªæ‹—å£çš„å‰ç¼€åç¼€ç›¸ç­‰ï¼Œæ­¤æ—¶çœ‹è¿‡ä¹‹å‰ã€Šå‰ç¼€å‡½æ•°ä¸ KMP ç®—æ³•ã€‹çš„å°ä¼™ä¼´ä»¬å¯èƒ½å·²ç»æœ‰æ‰€æ‚Ÿäº†ï¼Œ*

*æ²¡é”™ï¼Œå®é™…ä¸Šå¯¹ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§æƒ…å†µçš„è®¡ç®—çš„å…³é”®éƒ½ç¦»ä¸å¼€å‰ç¼€å‡½æ•°çš„è®¡ç®—å’Œå’Œåº”ç”¨*

é‚£ä¹ˆåªè¦ $j$ å–å€¼ä½¿å¾— $subpat$ åŒ…å«è¿™ä¸ªç›¸ç­‰çš„åç¼€ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¾—åˆ°ç¬¬äºŒç§æƒ…å†µçš„ $subpat$ çš„é‡ç°ï¼Œå¯¹äºä¾‹å­ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿å¾— $j \leqslant 5$ï¼Œ

è€Œå½“ $j = 5$ æ—¶ï¼Œå°±æ˜¯ $subpat$ å®Œå…¨åœ¨ $pat$ å¤´éƒ¨çš„è¾¹é™…æƒ…å†µã€‚

å¯ä»¥è®¡ç®—æ­¤æ—¶çš„ $delta_2(j)$ï¼š

è®¾æ­¤æ—¶è¿™å¯¹ç›¸ç­‰çš„å‰åç¼€é•¿åº¦ä¸º $\textit{prefixlen}$ï¼Œå¯çŸ¥ $subpatlen = patlastpos - j$ï¼Œé‚£ä¹ˆåœ¨ $pat$ å·¦è¾¹çš„éƒ¨åˆ†é•¿åº¦æ˜¯ $subpatlen-\textit{prefixlen}$ï¼Œ

è€Œ $rpr(j) = -(subpatlen-\textit{prefixlen})$ï¼Œæ‰€ä»¥å¾—åˆ° $delta_2(j) = patlastpos - rpr(j) = patlastpos \times 2 - j - \textit{prefixlen}$ã€‚

é‚£ä¹ˆé—®é¢˜åˆ°è¿™å„¿æ˜¯ä¸æ˜¯ç»“æŸäº†å‘¢ï¼Œå¹¶ä¸æ˜¯ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰å¤šå¯¹ç›¸ç­‰çš„å‰ç¼€å’Œåç¼€ï¼Œæ¯”å¦‚ï¼š

$$
\begin{aligned}
\textit{j}:\qquad\qquad\quad\ \ &\texttt{0 1 2 3 4 5 6 7 8 9} \\
\textit{pat}:\qquad\qquad\ \  &\texttt{A B A A B A A B A A} \\
\end{aligned}
$$

åœ¨ $j\leq2$ å¤„æœ‰ $\texttt{ABAABAA}$ï¼Œ$2< j \leq 5$ å¤„æœ‰ $\texttt{ABAA}$ï¼Œåœ¨ $5<j\leq8$ å¤„æœ‰ $\texttt{A}$

ä¹‹å‰æåˆ°çš„ Knuth ç®—æ³•çš„ç¼ºé™·å°±æ˜¯åªè€ƒè™‘äº†æœ€é•¿çš„é‚£ä¸€å¯¹çš„æƒ…å†µã€‚

æ‰€ä»¥å®é™…ä¸Šæˆ‘ä»¬è¦è€ƒè™‘æ‰€æœ‰ $subpat$ åç¼€ä¸ $pat$ å‰ç¼€ç›¸ç­‰çš„æƒ…å†µï¼Œå…¶å®ä¹Ÿå°±æ˜¯è®¡ç®— $pat$ æ‰€æœ‰çœŸåç¼€å’ŒçœŸå‰ç¼€ç›¸ç­‰çš„æƒ…å†µï¼Œç„¶åæŒ‰ç…§é•¿åº¦ä»å¤§åˆ°å°ï¼Œ$j$ åˆ†åŒºé—´è®¡ç®—

ä¸åŒçš„ $delta_2(j)$ã€‚è€Œå¦‚ä½•å¾—åˆ° $pat$ æ‰€æœ‰ç›¸ç­‰çš„çœŸå‰ç¼€å’ŒçœŸåç¼€é•¿åº¦å‘¢ï¼Ÿç­”æ¡ˆæ­£æ˜¯åˆ©ç”¨å‰ç¼€å‡½æ•°å’Œé€†å‘è¿ç”¨è®¡ç®—å‰ç¼€å‡½æ•°çš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š$j^{(n)} = \pi[j^{(n-1)}-1]$ã€‚

ä» $\pi[patlastpos]$ å¼€å§‹ä½œä¸ºæœ€é•¿ä¸€å¯¹çš„é•¿åº¦ï¼Œç„¶åé€šè¿‡é€†å‘è¿è¡ŒçŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªæ¬¡é•¿ç›¸ç­‰çœŸå‰ç¼€å’ŒçœŸåç¼€çš„é•¿åº¦ï¼Œç›´åˆ°è¿™é‡Œæˆ‘ä»¬å°±å®Œæˆäº†ç¬¬äºŒç§æƒ…å†µçš„ $delta_2$ çš„è®¡ç®—ã€‚

#### ç¬¬ä¸‰ç§æƒ…å†µ

$subpat$ çš„é‡ç°ä¸åœ¨åˆ«çš„åœ°æ–¹ï¼Œæ°å¥½å°±åœ¨ $pat$ ä¸­ï¼ˆä¸åŒ…æ‹¬ $pat$ çš„å¤´éƒ¨ï¼‰ã€‚

ä¹Ÿå°±æ˜¯æŒ‰ç…§ä»å³åˆ°å·¦çš„é¡ºåºï¼Œåœ¨ $pat[0\dots patlastpos-1]$ ä¸­å¯»æ‰¾ $subpat$ã€‚

*å¼€å¯è„‘æ´ï¼šæ—¢ç„¶æ˜¯ä¸ªå­—ç¬¦ä¸²æœç´¢çš„é—®é¢˜ï¼Œé‚£ä¹ˆå½“ç„¶å¯ä»¥ç”¨è‘—åçš„ BM ç®—æ³•æœ¬èº«è§£å†³ï¼Œäºæ˜¯æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ª BM çš„é€’å½’å®ç°çš„ç¬¬ä¸‰ç§æƒ…å†µï¼Œç»“æŸæ¡ä»¶æ˜¯ $patlen \leqslant  2$*

è€Œä¸”æ ¹æ® $delta_2$ çš„å®šä¹‰ï¼Œæ‰¾åˆ°çš„ $subpat$ çš„é‡ç°çš„ä¸‹ä¸€ä¸ªï¼ˆä¹Ÿå°±æ˜¯å·¦è¾¹ä¸€ä¸ªï¼‰å­—ç¬¦å’Œä½œä¸º $pat$ åç¼€çš„ $subpat$ çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸èƒ½ä¸€æ ·ã€‚

è¿™å°±å¾ˆå¥½åœ°å¯å‘äº†æˆ‘ä»¬ï¼ˆèµ·ç å¾ˆå¥½åœ°å¯å‘äº† Knuthï¼‰ä½¿ç”¨ç±»ä¼¼äºè®¡ç®—å‰ç¼€å‡½æ•°çš„è¿‡ç¨‹è®¡ç®—ç¬¬ä¸‰ç§æƒ…å†µï¼Œåªä¸è¿‡æ˜¯å·¦å³åè¿‡æ¥çš„å‰ç¼€å‡½æ•°ï¼š

- ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘å­ä¸²çš„å·¦ç«¯ç‚¹å’Œå­ä¸²æœ€é•¿å…¬å…±å‰åç¼€çš„â€œå‰ç¼€â€ä½ç½®ï¼Œä»å³å‘å·¦ç§»åŠ¨ï¼Œåœ¨å‘ç°æŒ‡å‘çš„ä¸¤ä¸ªå­—ç¬¦ç›¸ç­‰æ—¶ç»§ç»­ç§»åŠ¨ï¼Œæ­¤æ—¶ç›¸å½“äºâ€œå‰ç¼€â€å˜å¤§ï¼›
- å½“ä¸¤ä¸ªå­—ç¬¦ä¸ç›¸ç­‰æ—¶ï¼Œä¹‹å‰ç›¸ç­‰çš„éƒ¨åˆ†å°±æ»¡è¶³äº† $delta_2$ å¯¹é‡ç°çš„è¦æ±‚ï¼Œå¹¶ä¸”å›é€€æŒ‡å‘â€œå‰ç¼€â€ä½ç½®çš„æŒ‡é’ˆç›´åˆ°æ„æˆæ–°çš„å­—ç¬¦ç›¸ç­‰æˆ–è€…å‡ºç•Œã€‚

åŒå‰ç¼€å‡½æ•°ä¸€æ ·ï¼Œéœ€è¦ä¸€ä¸ªè¾…åŠ©æ•°ç»„ï¼Œç”¨äºå›é€€ï¼Œå¯ä»¥ä½¿ç”¨ä¹‹å‰è®¡ç®—ç¬¬äºŒç§æƒ…å†µæ‰€ç”Ÿæˆçš„å‰ç¼€æ•°ç»„çš„ç©ºé—´ã€‚

#### ä¸Šè¿°å®ç°

```rust
use std::cmp::PartialEq;
use std::cmp::min;

pub fn build_delta_2_table_improved_minghu6(p: &[impl PartialEq]) -> Vec<usize> {
    let patlen = p.len();
    let lastpos = patlen - 1;
    let mut delta_2 = Vec::with_capacity(patlen);

    // ç¬¬ä¸€ç§æƒ…å†µ
    // delta_2[j] = lastpos * 2 - j
    for i in 0..patlen {
        delta_2.push(lastpos * 2 - i);
    }

    // ç¬¬äºŒç§æƒ…å†µ
    // lastpos <= delata2[j] = lastpos * 2 - j
    let pi = compute_pi(p);  // è®¡ç®—å‰ç¼€å‡½æ•°
    let mut i = lastpos;
    let mut last_i = lastpos; // åªæ˜¯ä¸ºäº†åˆå§‹åŒ–
    while pi[i] > 0 {
        let start;
        let end;

        if i == lastpos {
            start = 0;
        } else {
            start = patlen - pi[last_i];
        }

        end = patlen - pi[i];

        for j in start..end {
            delta_2[j] = lastpos * 2 - j - pi[i];
        }

        last_i = i;
        i = pi[i] - 1;
    }

    // ç¬¬ä¸‰ç§æƒ…å†µ
    // delata2[j] < lastpos
    let mut j = lastpos;
    let mut t = patlen;
    let mut f = pi;
    loop {
        f[j] = t;
        while t < patlen && p[j] != p[t] {
            delta_2[t] = min(delta_2[t], lastpos - 1 - j);  // ä½¿ç”¨minå‡½æ•°ä¿è¯åé¢å¯èƒ½çš„å›é€€ä¸ä¼šè¦†ç›–å‰é¢çš„æ•°æ®
            t = f[t];
        }

        t -= 1;
        if j == 0 {
            break;
        }
        j -= 1;
    }

    // æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†å®Œæ•´å®šä¹‰
    delta_2[lastpos] = 0;

    delta_2
}
```

## Galil è§„åˆ™å¯¹å¤šæ¬¡åŒ¹é…æ—¶æœ€åæƒ…å†µçš„æ”¹å–„

### å…³äºåç¼€åŒ¹é…ç®—æ³•çš„å¤šæ¬¡åŒ¹é…é—®é¢˜

ä¹‹å‰çš„æœç´¢ç®—æ³•åªæ¶‰åŠåˆ°åœ¨ $string$ ä¸­å¯»æ‰¾ç¬¬ä¸€æ¬¡ $pat$ åŒ¹é…çš„æƒ…å†µï¼Œè€Œå¯¹ä¸åœ¨ $string$ ä¸­å¯»æ‰¾å…¨éƒ¨ $pat$ çš„åŒ¹é…çš„æƒ…å†µæœ‰å¾ˆå¤šä¸åŒçš„ç®—æ³•æ€è·¯ï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¸å¿ƒå…³æ³¨ç‚¹æ˜¯ï¼š

**å¦‚ä½•åˆ©ç”¨ä¹‹å‰åŒ¹é…æˆåŠŸçš„å­—ç¬¦çš„ä¿¡æ¯ï¼Œå°†æœ€åæƒ…å†µä¸‹çš„æ—¶é—´å¤æ‚åº¦é™ä¸ºçº¿æ€§ã€‚**

åœ¨åŸå§‹çš„æˆåŠŸåŒ¹é…åï¼Œç®€å•çš„ $string$ çš„æŒ‡é’ˆå‘åæ»‘åŠ¨ $patlen$ è·ç¦»åé‡æ–°å¼€å§‹åç¼€åŒ¹é…ï¼Œè¿™ä¼šå¯¼è‡´æœ€åæƒ…å†µä¸‹å›åˆ° $O(mn)$ çš„æ—¶é—´å¤æ‚åº¦ï¼ˆæŒ‰ç…§æƒ¯ä¾‹ï¼Œ$m$ ä¸º $patlen$ï¼Œ$n$ ä¸º $stringlen$ï¼Œä¸‹åŒï¼‰ã€‚

æ¯”å¦‚ä¸€ä¸ªæç«¯çš„ä¾‹å­ï¼š$pat$ï¼š$\texttt{AAA}$ï¼Œ$string$ï¼š$\texttt{AAAAA}\dots$ã€‚

å¯¹æ­¤ Knuth æå‡ºæ¥çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ç”¨ä¸€ä¸ªâ€œæ•°é‡æœ‰é™â€çš„çŠ¶æ€çš„é›†åˆæ¥è®°å½• $patlen$ é•¿åº¦çš„å­—ç¬¦ï¼Œè¿™ç§ç®—æ³•ä¿è¯ $string$ ä¸Šæ¯ä¸€ä¸ªå­—ç¬¦æœ€å¤šæ¯”è¾ƒä¸€æ¬¡ï¼Œä½†ä»£ä»·æ˜¯è¿™ä¸ªâ€œæ•°é‡æœ‰é™â€çš„çŠ¶æ€å¯èƒ½æ•°ç›®å¹¶ä¸æ€ä¹ˆâ€œæœ‰é™â€ï¼Œæ¯”å¦‚ç«‹åˆ»å°±èƒ½æƒ³åˆ°å®ƒçš„ä¸Šé™æ˜¯ $2^{m}$ ä¸ªï¼Œä½†å¹¶ä¸æ¸…æ¥šå®ƒåˆ°åº•èƒ½å˜å¾—å¤šå¤§ï¼Œå¯¹äºä¸€ä¸ªå­—ç¬¦å½¼æ­¤ä¸ç›¸ç­‰çš„ $pat$ï¼Œéœ€è¦ $\dfrac{1}{2}m^{2}+m$ ä¸ªçŠ¶æ€ã€‚è¿™ä¸ªç®—æ³•æ€è·¯åŒåœ¨ 1977 å¹´ 6 æœˆçš„å‘è¡¨ KMP è®ºæ–‡[^kmp]é‡Œè¢«ä»‹ç»ï¼Œä¹Ÿè®¸åœ¨æœªæ¥æŸä¸ªèŠ‚ç‚¹åŒ¹é…ä»£ä»·å¾ˆé«˜ä½†çŠ¶æ€å­˜å‚¨ä»£ä»·å¾ˆä½çš„æ–°åœºæ™¯èƒ½é‡æ–°å¾—åˆ°åº”ç”¨ï¼Œä½†å¯¹äºç°åœ¨ç®€å•çš„å­—ç¬¦ä¸²åŒ¹é…ï¼Œè¿™ä¸ªè®¾è®¡å¹¶ä¸ç‰¹åˆ«åˆé€‚ã€‚

è€Œ Knuth æå‡ºçš„å¦ä¸€ä¸ªæ–¹æ³•ï¼Œå—¯è¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼ŒåŒåœ¨ä¸Šé¢çš„ Knuth é‚£ç¯‡â€œå®è—â€è®ºæ–‡é‡Œè¢«ä»‹ç»ï¼Œç¼ºç‚¹æ˜¯é™¤äº†è¿‡äºå¤æ‚ä»¥å¤–ä¸»è¦æ˜¯æ„å»ºè¾…åŠ©çš„æ•°æ®ç»“æ„éœ€è¦çš„é¢„å¤„ç†æ—¶é—´å¤ªå¤§ï¼š$O(qm)$

$q$ ä¸ºå…¨å­—ç¬¦é›†çš„å¤§å°ï¼Œè€Œä¸” $qm$ å‰é¢çš„ç³»æ•°å¾ˆå¤§ã€‚

äºæ˜¯åœ¨è¿™ä¸ªèƒŒæ™¯ä¸‹å°±æœ‰äº†ä¸‹é¢ä»‹ç»çš„æ€è·¯ç®€å•ï¼Œä¸éœ€è¦é¢å¤–é¢„å¤„ç†å¼€é”€çš„ Galil ç®—æ³•[^galil-rule]ã€‚

### Galil è§„åˆ™

åŸç†å¾ˆç®€å•ï¼Œå‡å®šä¸€ä¸ª $pat$ï¼Œå®ƒæ˜¯æŸä¸ªå­ä¸² $U$ é‡å¤ n æ¬¡æ„æˆçš„å­—ç¬¦ä¸² $UUUU\dots$ çš„å‰ç¼€ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç§° $U$ ä¸º $pat$ çš„ä¸€ä¸ªå‘¨æœŸã€‚

æ¯”å¦‚ï¼Œ$pat:$$\texttt{ABCABCAB}$ï¼Œæ˜¯ $\texttt{ABC}$ çš„é‡å¤ $\texttt{ABCABCABC}$ çš„å‰ç¼€ï¼Œæ‰€ä»¥ $\texttt{ABC}$ çš„é•¿åº¦ $3$ å°±æ˜¯è¿™ä¸ª $pat$ çš„å‘¨æœŸé•¿åº¦ï¼Œä¹Ÿå³ $pat$ æ»¡è¶³ $pat[i] = pat[i+3]$ã€‚

å½“ç„¶å…¶å® $\texttt{ABCABC}\dots$ ä¹Ÿæ˜¯ $pat$ çš„å‘¨æœŸï¼Œä½†æˆ‘ä»¬åªå…³æ³¨æœ€çŸ­çš„é‚£ä¸ªã€‚

äº‹å®ä¸Šï¼Œå¹¿ä¹‰åœ°è®²ï¼Œ$pat$ è‡³å°‘æ‹¥æœ‰ä¸€ä¸ªé•¿åº¦ä¸ºå®ƒè‡ªèº«çš„å‘¨æœŸã€‚

æˆ‘ä»¬è§„å®šè¿™ä¸ªæœ€çŸ­çš„å‘¨æœŸä¸º $k$ï¼Œ$k\leq patlen$ã€‚

åœ¨æœç´¢è¿‡ç¨‹ä¸­ï¼Œå‡å¦‚æˆ‘ä»¬çš„ $pat$ æˆåŠŸåœ°å®Œæˆäº†ä¸€æ¬¡åŒ¹é…ï¼Œé‚£ä¹ˆä¾ç…§å‘¨æœŸçš„ç‰¹ç‚¹ï¼Œå®é™…ä¸Šåªéœ€å°† $string$ å‘åæ»‘åŠ¨ $k$ ä¸ªå­—ç¬¦ï¼Œæ¯”è¾ƒè¿™ $k$ ä¸ªå­—ç¬¦æ˜¯å¦å¯¹åº”ç›¸ç­‰å°±å¯ä»¥ç›´æ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨ $pat$ çš„åˆä¸€ä¸ªåŒ¹é…ã€‚

è€Œå¦‚ä½•è®¡ç®—è¿™ä¸ªæœ€çŸ­å‘¨æœŸçš„é•¿åº¦å‘¢ï¼Œå‡å¦‚æˆ‘ä»¬çŸ¥é“ $pat$ çš„ç›¸ç­‰çš„ä¸€å¯¹å„¿å‰ç¼€ - åç¼€ï¼Œè®¾å®ƒä»¬çš„é•¿åº¦ä¸º $\textit{prefixlen}$ï¼Œé‚£ä¹ˆæœ‰ $pat[i] = pat[i+(patlen-\textit{prefixlen})]$ã€‚

è€Œä»æ•°å­¦çš„è§’åº¦çœ‹è¿™ä¸ªå…¬å¼ï¼Œæ˜¾ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†é•¿åº¦ä¸º $patlen-\textit{prefixlen}$ çš„å‘¨æœŸï¼Œè€Œå½“æˆ‘ä»¬çŸ¥é“ $pat$ æœ€é•¿çš„é‚£ä¸€å¯¹ç›¸ç­‰çš„å‰ç¼€ - åç¼€ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† $pat$ æœ€çŸ­çš„å‘¨æœŸã€‚

è€Œè¿™ä¸ªæœ€é•¿ç›¸ç­‰çš„å‰åç¼€é•¿åº¦ï¼Œ$\pi[patlastpos]$ï¼Œåœ¨æˆ‘ä»¬åœ¨è®¡ç®— $delta_2$ çš„æ—¶å€™å·²ç»è®¡ç®—è¿‡äº†ï¼Œæ‰€ä»¥å®é™…ä¸éœ€è¦é¢å¤–çš„é¢„å¤„ç†æ—¶é—´å’Œç©ºé—´ï¼Œå°±èƒ½æ”¹å–„åç¼€åŒ¹é…ç®—æ³•æœ€åæƒ…å†µçš„æ—¶é—´å¤æ‚åº¦ä¸ºçº¿æ€§ã€‚

### ç»“åˆä¸Šè¿°ä¼˜åŒ–çš„ BM çš„æœç´¢ç®—æ³•æœ€ç»ˆå®ç°

```rust
#[cfg(target_pointer_width = "64")]
const LARGE: usize = 10_000_000_000_000_000_000;

#[cfg(not(target_pointer_width = "64"))]
const LARGE: usize = 2_000_000_000;

pub struct BMPattern<'a> {
    pat_bytes: &'a [u8],
    delta_1: [usize; 256],
    delta_2: Vec<usize>,
    k: usize  // patçš„æœ€çŸ­å‘¨æœŸé•¿åº¦
}

impl<'a> BMPattern<'a> {
    // ...

    pub fn find_all(&self, string: &str) -> Vec<usize> {
        let mut result = vec![];
        let string_bytes = string.as_bytes();
        let stringlen = string_bytes.len();
        let patlen = self.pat_bytes.len();
        let pat_last_pos = patlen - 1;
        let mut string_index = pat_last_pos;
        let mut pat_index;
        let l0 =  patlen - self.k;
        let mut l = 0;

        while string_index < stringlen {
            let old_string_index = string_index;

            while string_index < stringlen {
                string_index += self.delta0(string_bytes[string_index]);
            }
            if string_index < LARGE {
                break;
            }

            string_index -= LARGE;

            // å¦‚æœstring_indexå‘ç”Ÿç§»åŠ¨ï¼Œæ„å‘³ç€è‡ªä»ä¸Šæ¬¡æˆåŠŸåŒ¹é…åå‘ç”Ÿäº†è‡³å°‘ä¸€æ¬¡çš„å¤±è´¥åŒ¹é…ã€‚
            // æ­¤æ—¶éœ€è¦å°†Galilè§„åˆ™çš„äºŒæ¬¡åŒ¹é…çš„åç§»é‡å½’é›¶ã€‚
            if old_string_index < string_index {
                l = 0;
            }

            pat_index = pat_last_pos;

            while pat_index > l && string_bytes[string_index] == self.pat_bytes[pat_index] {
                string_index -= 1;
                pat_index -= 1;
            }

            if pat_index == l && string_bytes[string_index] == self.pat_bytes[pat_index] {
                result.push(string_index - l);

                string_index += pat_last_pos - l + self.k;
                l = l0;
            } else {
                l = 0;
                string_index += max(
                    self.delta_1[string_bytes[string_index] as usize],
                    self.delta_2[pat_index],
                );
            }
        }

        result
    }
}
```

### æœ€åæƒ…å†µåœ¨å®è·µä¸­æ€§èƒ½å½±å“

ä»å®è·µçš„è§’åº¦ä¸Šè¯´ï¼Œç†è®ºä¸Šçš„æœ€åæƒ…å†µå¹¶ä¸å®¹æ˜“å½±å“æ€§èƒ½è¡¨ç°ï¼Œå“ªæ€•æ˜¯å¾ˆå°çš„åªæœ‰ 4 çš„å­—ç¬¦é›†çš„éšæœºæ–‡æœ¬æµ‹è¯•ä¸‹è¿™ç§æœ€åæƒ…å†µçš„å½±å“ä¹Ÿå°åˆ°éš¾ä»¥è§‚å¯Ÿã€‚

ä¹Ÿå› æ­¤å¦‚æœæ²¡æœ‰å¾ˆå¥½åœ°è®¾è®¡ï¼Œä½¿ç”¨ Galil æ³•åˆ™ä¼šæ‹–ç´¯ä¸€ç‚¹å¹³å‡çš„æ€§èƒ½è¡¨ç°ï¼Œä½†å¯¹äºä¸€äº›æç«¯ç‰¹æ®Šçš„ $pat$ å’Œ $string$ æ¯”å¦‚ä¾‹å­ä¸­çš„ï¼š$pat$ï¼š$\texttt{AAA}$ï¼Œ$string$ï¼š$\texttt{AAAAA}\dots$ï¼ŒGalil è§„åˆ™çš„åº”ç”¨ç¡®å®ä¼šä½¿å¾—æ€§èƒ½è¡¨ç°æé«˜æ•°å€ã€‚

## å®è·µåŠåç»­

è¿™ä¸ªéƒ¨åˆ†è¦è®¨è®ºå®è·µä¸­çš„å…·ä½“é—®é¢˜ã€‚

å°½ç®¡å‰é¢ç»™å‡ºäº†ä¸€äº›ç®—æ³•çš„å®ç°ä»£ç ï¼Œä½†å¹¶æ²¡æœ‰çœŸæ­£è®¨è®ºè¿‡å®Œæ•´å®ç°å¯èƒ½é¢ä¸´çš„ä¸€äº›â€œå°é—®é¢˜â€ã€‚

### å­—ç¬¦ç±»å‹çš„è€ƒè™‘

åœ¨è‹±è¯­ç¯å¢ƒä¸‹ï¼Œç‰¹åˆ«æ˜¯ä¸Šä¸–çºª 70 å¹´ä»£é‚£ä¸ªæ—¶å€™ï¼Œäººä»¬è€ƒè™‘å­—ç¬¦ï¼Œé»˜è®¤çš„å‰ææ˜¯å®ƒæ˜¯ ASCII ç ï¼Œé€šç”¨å­—ç¬¦è¡¨æ˜¯å®¹æ˜“é€šè¿‡ä¸€ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„æ¥ç¡®å®šçš„ã€‚$delta_1$ çš„åˆå§‹åŒ–åªéœ€è¦åŸºäºè¿™ä¸ªå›ºå®šå¤§å°çš„æ•°ç»„ã€‚

è€Œåœ¨å°è¯•ç”¨ Rust å®ç°ä¸Šè¿°ç®—æ³•çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªé‡åˆ°çš„é—®é¢˜æ˜¯å­—ç¬¦çš„é—®é¢˜ï¼Œç”¨ä¸€é—¨å¾ˆæ–°çš„ 2010 + å‘å±•èµ·æ¥çš„è¯­è¨€æ¥å®ç° 1970 + æ—¶ä»£çš„ç®—æ³•ï¼Œæ˜¯ä¸€ä»¶å¾ˆæœ‰æ„æ€çš„äº‹æƒ…ã€‚

ä¼šè§‚å¯Ÿåˆ°ä¸€äº›å› æ—¶ä»£å‘å±•è€Œäº§ç”Ÿçš„ä¸€äº›å˜åŒ–ï¼Œç°ä»£çš„ç¼–ç¨‹è¯­è¨€ï¼Œå†…ç”Ÿçš„ `char` ç±»å‹å°±æ˜¯ Unicodeï¼Œé¦–å…ˆä¸å¯èƒ½ç”¨ä¸€ä¸ªå…¨å­—ç¬¦é›†å¤§å°çš„æ•°ç»„æ¥è®¡ç®— $delta_1$ï¼Œï¼ˆå…¶å®ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯å®Œæˆä¸€ä¸ª UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²æœç´¢å¯èƒ½éœ€è¦é¢å¤– 1GB å†…å­˜ï¼‰ä½†æ˜¯å¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨æ¥ä»£æ›¿ï¼ŒåŒæ ·æ˜¯ $O(1)$ çš„éšæœºè®¿é—®æˆæœ¬ï¼Œæ¯•ç«Ÿå“ˆå¸Œè¡¨æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€æœ€åŸºç¡€çš„æ ‡å‡†ä»¶ä¹‹ä¸€äº†ï¼ˆå“ªæ€•æ˜¯ Go éƒ½æœ‰å‘¢ï¼‰ã€‚

ä½†æ›´ä¸¥é‡çš„é—®é¢˜æ˜¯ Unicode ä½¿ç”¨çš„éƒ½æ˜¯å˜é•¿çš„å­—èŠ‚ç¼–ç æ–¹æ¡ˆï¼Œæ‰€ä»¥æ²¡åŠæ³•ç›´æ¥æŒ‰ç…§å­—ç¬¦ä¸ªæ•°è®¡ç®—è·³è½¬çš„å­—èŠ‚æ•°ï¼Œå½“ç„¶ï¼Œå¦‚æœé™å®šæ–‡æœ¬æ˜¯ç®€å•çš„ ASCII å­—ç¬¦é›†ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥æŒ‰ç…§ 1 å­—ç¬¦å®½ 1 å­—èŠ‚æ¥è¿›è¡Œå¿«é€Ÿè·³è½¬ï¼Œä½†è¿™æ ·çš„å®ç°æ ¹æœ¬å°±æ²¡å•¥åµç”¨ï¼ğŸ˜ 

åœ¨æ€è€ƒçš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆçš„ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥å°†å­—ç¬¦ä¸²è½¬ä¸ºæŒ‰å­—ç¬¦ç´¢å¼•çš„å‘é‡æ•°ç»„ï¼Œä½†è¿™æ„å‘³ç€å•¥éƒ½ä¸ç”¨åšå°±å…ˆæœ‰äº†ä¸€ä¸ªéå†å­—ç¬¦ä¸²çš„æ—¶é—´å¼€é”€ï¼Œå’Œé¢å¤–çš„å¤§äºç­‰äºå­—ç¬¦ä¸²å­—èŠ‚æ•°çš„é¢å¤–ç©ºé—´å¼€é”€ï¼ˆå› ä¸º `char` ç±»å‹æ˜¯ Unicode å­—é¢å€¼ï¼Œé‡‡ç”¨å›ºå®š 4 å­—èŠ‚å¤§å°ä¿å­˜ï¼‰ã€‚

äºæ˜¯æˆ‘æ”¹è¿›äº†æ€è·¯ï¼Œå¯¹äºå˜é•¿ç¼–ç å­—ç¬¦ä¸²ï¼Œè‡³å°‘è¦å®Œå…¨éå†ä¸€éï¼Œæ‰èƒ½å®Œæˆå­—ç¬¦ä¸²åŒ¹é…ï¼Œé‚£ä¹ˆåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä½¿ç”¨ä¸€ä¸ªåŸºäºå¯å¢é•¿çš„ç¯ç»“æ„å®ç°çš„åŒå¤´é˜Ÿåˆ—ä½œä¸ºæ»‘åŠ¨çª—å£ï¼Œä¿å­˜è¿‡å» $patlen$ ä¸ªå­—ç¬¦ï¼Œå¦‚æœå½“å‰ $string$ çš„ç´¢å¼•å°äºç®—æ³•è®¡ç®—çš„è·³è½¬ï¼Œå°±è®©å¾ªç¯ç©ºè½¬ç›´åˆ°ç­‰äºç®—æ³•è¦æ±‚çš„ç´¢å¼•ã€‚å®è·µè¯æ˜ï¼Œè¿™ä¸ªå·§å¦™çš„è®¾è®¡ä½¿å¾—åœ¨ä¸€èˆ¬å­—ç¬¦ä¸Šæœç´¢çš„ BM ç®—æ³•çš„å®ç°æ¯”æš´åŠ›åŒ¹é…ç®—æ³•è¿˜è¦æ…¢ä¸€äº›ã€‚ğŸ˜³ğŸ˜³

äºæ˜¯æŒ«æŠ˜ä½¿æˆ‘å›°æƒ‘ï¼Œå›°æƒ‘ä½¿æˆ‘æ€è€ƒï¼Œç»ˆäºä¸€æŸé˜³å…‰ç…§è¿›äº†çŸ³å¤´ç¼é‡Œï¼š

1. å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•é«˜æ•ˆçš„å…³é”®åœ¨äºå­—ç¬¦ç´¢å¼•çš„å¿«é€Ÿè·³è½¬
2. å­—ç¬¦ç´¢å¼•ä¸€å®šè¦å»ºç«‹åœ¨ç­‰å®½å­—ç¬¦çš„åŸºç¡€ä¸Šï¼Œ

åŸºäºè¿™ä¸¤æ¡åŸåˆ™æ€è€ƒï¼Œæˆ‘å°±å‘ç°äºŒè¿›åˆ¶å­—èŠ‚æœ¬èº«ï¼š1 å­—èŠ‚ç­‰å®½ã€å­—ç¬¦å…¨é›†å¤§å°æ˜¯ 256ï¼Œå°±æ˜¯ç¬¦åˆæ¡ä»¶çš„å®Œç¾å­—ç¬¦ï¼åœ¨è¿™ä¸ªåŸºç¡€ä¸Šå®Œæˆäº†ä¸€ç³»åˆ—åç¼€åŒ¹é…ç®—æ³•çš„é«˜æ•ˆå®ç°ã€‚

### Simplified Boyer-Moore ç®—æ³•

BM ç®—æ³•æœ€å¤æ‚çš„åœ°æ–¹å°±åœ¨äº $delta_2$ è¡¨ï¼ˆé€šä¿—çš„åå­—æ˜¯å¥½åç¼€è¡¨ï¼‰çš„æ„å»ºï¼Œè€Œå®è·µä¸­å‘ç°ï¼Œåœ¨ä¸€èˆ¬çš„å­—ç¬¦é›†ä¸Šçš„åŒ¹é…æ€§èƒ½ä¸»è¦ä¾é  $delta_1$ è¡¨ï¼ˆé€šä¿—çš„åå­—æ˜¯åå­—ç¬¦è¡¨ï¼‰ï¼Œäºæ˜¯å‡ºç°äº†ä»…ä»…ä½¿ç”¨ $delta_1$ è¡¨çš„ç®€åŒ–ç‰ˆ BM ç®—æ³•ï¼Œé€šå¸¸è¡¨ç°å’Œå®Œæ•´ç‰ˆå·®è·å¾ˆå°ã€‚

### Boyer-Moore-Horspol ç®—æ³•

Horspol ç®—æ³•åŒæ ·æ˜¯åŸºäºåå­—ç¬¦çš„è§„åˆ™ï¼Œä¸è¿‡æ˜¯åœ¨ä¸ $pat$ å°¾éƒ¨å¯¹é½çš„å­—ç¬¦ä¸Šåº”ç”¨ $delta_1$ï¼Œè¿™ä¸ªæ•ˆæœç±»ä¼¼äºå‰æ–‡å¯¹åŒ¹é…ç®—æ³•çš„æ”¹è¿›ï¼Œæ‰€ä»¥å®ƒçš„é€šå¸¸è¡¨ç°ä¼˜äºåŸå§‹ BM å’ŒåŒ¹é…ç®—æ³•æ”¹è¿›åçš„ BM å·®ä¸å¤šã€‚

```rust
pub struct HorspoolPattern<'a> {
    pat_bytes: &'a [u8],
    bm_bc: [usize; 256],
}

impl<'a> HorspoolPattern<'a> {
    // ...
    pub fn find_all(&self, string: &str) -> Vec<usize> {
        let mut result = vec![];
        let string_bytes = string.as_bytes();
        let stringlen = string_bytes.len();
        let pat_last_pos = self.pat_bytes.len() - 1;
        let mut string_index = pat_last_pos;

        while string_index < stringlen {
            if &string_bytes[string_index-pat_last_pos..string_index+1] == self.pat_bytes {
                result.push(string_index-pat_last_pos);
            }

            string_index += self.bm_bc[string_bytes[string_index] as usize];
        }

        result
    }
}
```

### Boyer-Moore-Sunday ç®—æ³•

Sunday ç®—æ³•åŒæ ·æ˜¯åˆ©ç”¨åå­—ç¬¦è§„åˆ™ï¼Œåªä¸è¿‡ç›¸æ¯” Horspool å®ƒæ›´è¿›ä¸€æ­¥ï¼Œç›´æ¥å…³æ³¨ $pat$ å°¾éƒ¨å¯¹é½çš„é‚£ä¸ªå­—ç¬¦çš„ä¸‹ä¸€ä¸ªå­—ç¬¦ã€‚

å®ç°å®ƒåªéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ $delta_1$ è¡¨ï¼Œä½¿å¾—å®ƒç›¸å½“äºåœ¨ $patlen+1$ é•¿åº¦çš„ $pat$ ä¸Šè¿›è¡Œæ„å»ºã€‚

Sunday ç®—æ³•é€šå¸¸ç”¨ä½œä¸€èˆ¬æƒ…å†µä¸‹å®ç°æœ€ç®€å•è€Œä¸”å¹³å‡è¡¨ç°æœ€å¥½ä¹‹ä¸€çš„å®ç”¨ç®—æ³•ï¼Œé€šå¸¸è¡¨ç°æ¯” Horspoolã€BM éƒ½è¦å¿«ä¸€ç‚¹ã€‚

```rust
pub struct SundayPattern<'a> {
    pat_bytes: &'a [u8],
    sunday_bc: [usize; 256],
}

impl<'a> SundayPattern<'a> {
    // ...
    fn build_sunday_bc(p: &'a [u8]) -> [usize; 256] {
        let mut sunday_bc_table = [p.len() + 1; 256];

        for i in 0..p.len() {
            sunday_bc_table[p[i] as usize] = p.len() - i;
        }

        sunday_bc_table
    }

    pub fn find_all(&self, string: &str) -> Vec<usize> {
        let mut result = vec![];
        let string_bytes = string.as_bytes();
        let pat_last_pos = self.pat_bytes.len() - 1;
        let stringlen = string_bytes.len();
        let mut string_index = pat_last_pos;

        while string_index < stringlen {
            if &string_bytes[string_index - pat_last_pos..string_index+1] == self.pat_bytes {
                result.push(string_index - pat_last_pos);
            }

            if string_index + 1 == stringlen {
                break;
            }

            string_index += self.sunday_bc[string_bytes[string_index + 1] as usize];
        }

        result
    }
}
```

### BMHBNFS ç®—æ³•

è¯¥ç®—æ³•ç»“åˆäº† Horspool å’Œ Sundayï¼Œæ˜¯ CPython å®ç° `stringlib` æ¨¡å—æ—¶ç”¨åˆ°çš„ `find` çš„ç®—æ³•[^b5s]ï¼Œä¼¼ä¹å›½å†…æ›´æœ‰åæ°”ï¼Œä¸æ¸…æ¥šä¸ºä½•å«è¿™ä¸ªåå­—ï¼Œæ€ä¹ˆå°±â€œAKAâ€äº†ï¼Ÿ

ä»¥ä¸‹ç®€ç§° B5Sã€‚

B5S åŸºæœ¬æƒ³æ³•æ˜¯ï¼š

1. æŒ‰ç…§åç¼€åŒ¹é…çš„æ€è·¯ï¼Œé¦–å…ˆæ¯”è¾ƒ $patlastpos$ ä½ç½®å¯¹åº”çš„å­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å°±æ¯”è¾ƒ $0\dots patlastpos-1$ å¯¹åº”ä½ç½®çš„å­—ç¬¦æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœä»ç„¶ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±å‘ç°ä¸€ä¸ªåŒ¹é…ï¼›

2. å¦‚æœä»»ä½•ä¸€ä¸ªé˜¶æ®µå‘ç”Ÿä¸åŒ¹é…ï¼Œå°±è¿›å…¥è·³è½¬é˜¶æ®µï¼›

3.  åœ¨è·³è½¬é˜¶æ®µï¼Œé¦–å…ˆè§‚å¯Ÿ $patlastpos$ ä½ç½®çš„ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¦åœ¨ $pat$ ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œç›´æ¥å‘å³æ»‘åŠ¨ $patlen+1$ï¼Œè¿™æ˜¯ Sunday ç®—æ³•çš„æœ€å¤§åˆ©ç”¨ï¼›

    å¦‚æœè¿™ä¸ªå­—ç¬¦åœ¨ $pat$ ä¸­ï¼Œå¯¹ $patlastpos$ å¤„çš„å­—ç¬¦åˆ©ç”¨ $delta_1$ è¿›è¡Œ Horspool è·³è½¬ã€‚

è€Œè¿™ä¸ªç®—æ³•æ ¹æ®æ—¶é—´èŠ‚çœè¿˜æ˜¯ç©ºé—´èŠ‚çœä¸ºç¬¬ä¸€ç›®æ ‡ï¼Œä¼šæœ‰å·®åˆ«å·¨å¤§çš„ä¸åŒå®ç°ã€‚

#### æ—¶é—´èŠ‚çœç‰ˆæœ¬

```rust
pub struct B5STimePattern<'a> {
    pat_bytes: &'a [u8],
    alphabet: [bool;256],
    bm_bc: [usize;256],
    k: usize
}

impl<'a> B5STimePattern<'a> {
    pub fn new(pat: &'a str) -> Self {
        assert_ne!(pat.len(), 0);

        let pat_bytes = pat.as_bytes();
        let (alphabet, bm_bc, k) = B5STimePattern::build(pat_bytes);

        B5STimePattern { pat_bytes, alphabet, bm_bc, k }
    }

    fn build(p: &'a [u8]) -> ([bool;256], [usize;256], usize)  {
        let mut alphabet = [false;256];
        let mut bm_bc = [p.len(); 256];
        let lastpos = p.len() - 1;

        for i in 0..lastpos {
            alphabet[p[i] as usize] = true;
            bm_bc[p[i] as usize] = lastpos - i;
        }

        alphabet[p[lastpos] as usize] = true;

        (alphabet, bm_bc, compute_k(p))
    }

    pub fn find_all(&self, string: &str) -> Vec<usize> {
        let mut result = vec![];
        let string_bytes = string.as_bytes();
        let pat_last_pos = self.pat_bytes.len() - 1;
        let patlen = self.pat_bytes.len();
        let stringlen = string_bytes.len();
        let mut string_index = pat_last_pos;
        let mut offset = pat_last_pos;
        let offset0 = self.k - 1;

        while string_index < stringlen {
            if string_bytes[string_index] == self.pat_bytes[pat_last_pos] {
                if &string_bytes[string_index-offset..string_index] == &self.pat_bytes[pat_last_pos-offset..pat_last_pos] {
                    result.push(string_index-pat_last_pos);

                    offset = offset0;

                    // Galil rule
                    string_index += self.k;
                    continue;
                }
            }

            if string_index + 1 == stringlen {
                break;
            }

            offset = pat_last_pos;

            if !self.alphabet[string_bytes[string_index+1] as usize] {
                string_index += patlen + 1;  // sunday
            } else {
                string_index += self.bm_bc[string_bytes[string_index] as usize];  // horspool
            }
        }

        result
    }
}
```

è¿™ä¸ªç‰ˆæœ¬çš„ B5S æ€§èƒ½è¡¨ç°éå¸¸ç†æƒ³ï¼Œæ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œç›®å‰ä»‹ç»çš„åç¼€åŒ¹é…ç³»åˆ—ç®—æ³•ä¸­æœ€å¿«çš„ã€‚

#### ç©ºé—´èŠ‚çœç‰ˆæœ¬

è¿™ä¹Ÿæ˜¯ CPython `stringlib` ä¸­å®ç°çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨äº†ä¸¤ä¸ªæ•´æ•°è¿‘ä¼¼å–ä»£äº†å­—ç¬¦è¡¨å’Œ $delta_1$ çš„ä½œç”¨ï¼Œæå¤§åœ°èŠ‚çœäº†ç©ºé—´ï¼š

##### ç”¨ä¸€ä¸ªç®€å•çš„ Bloom è¿‡æ»¤å™¨å–ä»£å­—ç¬¦è¡¨ï¼ˆalphabetï¼‰

```rust
pub struct BytesBloomFilter {
    mask: u64,
}

impl BytesBloomFilter {
    pub fn new() -> Self {
        SimpleBloomFilter {
            mask: 0,
        }
    }

    fn insert(&mut self, byte: &u8) {
        (self.mask) |= 1u64 << (byte & 63);
    }

    fn contains(&self, char: &u8) -> bool {
        (self.mask & (1u64 << (byte & 63))) != 0
    }
}
```

Bloom è¿‡æ»¤å™¨è®¾è®¾è®¡é€šè¿‡ç‰ºç‰²å‡†ç¡®ç‡ï¼ˆå®é™…è¿˜æœ‰è¿è¡Œæ—¶é—´ï¼‰æ¥æå¤§åœ°èŠ‚çœå­˜å‚¨ç©ºé—´çš„ `Set` ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œå®ƒçš„ç‰¹ç‚¹æ˜¯ä¼šå°†é›†åˆä¸­ä¸å­˜åœ¨çš„é¡¹è¯¯åˆ¤ä¸ºå­˜åœ¨ï¼ˆFalse Positivesï¼Œç®€ç§° FPï¼‰ï¼Œä½†ä¸ä¼šæŠŠé›†åˆä¸­å­˜åœ¨çš„é¡¹åˆ¤æ–­ä¸ºä¸å­˜åœ¨ï¼ˆFalse Negativesï¼Œç®€ç§° FNï¼‰ï¼Œå› æ­¤ä½¿ç”¨å®ƒå¯èƒ½ä¼šå› ä¸º FP è€Œæ²¡æœ‰å¾—åˆ°æœ€å¤§çš„å­—ç¬¦è·³è½¬ï¼Œä½†ä¸ä¼šå› ä¸º FN è€Œè·³è¿‡æœ¬åº”åŒ¹é…çš„å­—ç¬¦ã€‚

ç†è®ºä¸Šåˆ†æï¼Œä¸Šè¿°â€œBloom è¿‡æ»¤å™¨â€çš„å®ç°åœ¨ $pat$ é•¿åº¦åœ¨ 50 ä¸ª Bytes æ—¶ï¼ŒFP æ¦‚ç‡çº¦ä¸º 0.5ï¼Œè€Œ $pat$ é•¿åº¦åœ¨ 10 ä¸ª Bytes æ—¶ï¼ŒFP æ¦‚ç‡çº¦ä¸º 0.15ã€‚

å½“ç„¶è¿™ä¸æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Bloom è¿‡æ»¤å™¨ï¼Œé¦–å…ˆå®ƒå®é™…ä¸Šæ²¡æœ‰ä½¿ç”¨ä¸€ä¸ªçœŸæ­£çš„å“ˆå¸Œå‡½æ•°ï¼Œå®é™…ä¸Šå®ƒåªæ˜¯ä¸€ä¸ªå­—ç¬¦æ˜ å°„ï¼Œå°±æ˜¯å°† 0-255 çš„å­—èŠ‚æ˜ å°„ä¸ºå®ƒçš„å‰å…­ä½æ„æˆçš„æ•°ï¼Œè€ƒè™‘åˆ°æˆ‘ä»¬åœ¨åšå†…å­˜ä¸Šçš„å­—ç¬¦æœç´¢ï¼Œè¿™æ ·çš„ç®€åŒ–å°±éå¸¸é‡è¦ï¼Œå› ä¸ºå³ä½¿ç”¨ç›®å‰å·²çŸ¥æœ€å¿«çš„éåŠ å¯†å“ˆå¸Œç®—æ³• [xxHash](https://cyan4973.github.io/xxHash/)ï¼Œè®¡ç®—æ‰€éœ€è¦çš„æ—¶é—´éƒ½è¦æ¯”å®ƒé«˜ä¸€ä¸ªæ•°é‡çº§ã€‚

å¦å¤–ï¼ŒæŒ‰ç…§è®¡ç®—ï¼Œå½“ pat åœ¨ 30 å­—èŠ‚ä»¥ä¸‹æ—¶ï¼Œä¸ºäº†è¾¾åˆ°æœ€ä½³çš„ FP æ¦‚ç‡ï¼Œéœ€è¦è¶…è¿‡ä¸€ä¸ªå“ˆå¸Œå‡½æ•°ï¼Œä½†è¿™ä¹ˆåšæ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºç”¨è£…æœ‰ä¸¤ä¸ª `u128` æ•°å­—çš„æ•°ç»„å°±å·²ç»å¯ä»¥æ„å»ºå­—ç¬¦è¡¨çš„å…¨å­—ç¬¦é›†ã€‚

##### ä½¿ç”¨ $delta_1(pat[patlastpos])$ ä»£æ›¿æ•´ä¸ª $delta_1$

è§‚å¯Ÿ $delta_1$ æœ€å¸¸ä½¿ç”¨çš„åœ°æ–¹å°±æ˜¯åç¼€åŒ¹é…æ—¶ç¬¬ä¸€ä¸ªå­—ç¬¦å°±ä¸åŒ¹é…æ˜¯æœ€å¸¸è§çš„ä¸åŒ¹é…çš„æƒ…å†µï¼Œäºæ˜¯ä»¤ `skip = delta1(pat[patlastpos])`ï¼Œ

åœ¨ç¬¬ä¸€é˜¶æ®µä¸åŒ¹é…æ—¶ï¼Œç›´æ¥å‘ä¸‹æ»‘åŠ¨ `skip` ä¸ªå­—ç¬¦ï¼›ä½†å½“ç¬¬äºŒé˜¶æ®µä¸é…æ—¶ï¼Œå› ä¸ºç¼ºä¹æ•´ä¸ª $delta_1$ çš„ä¿¡æ¯ï¼Œåªèƒ½å‘ä¸‹æ»‘åŠ¨ä¸€ä¸ªå­—ç¬¦ã€‚

```rust
pub struct B5SSpacePattern<'a> {
    pat_bytes: &'a [u8],
    alphabet: BytesBloomFilter,
    skip: usize,
}

impl<'a> B5SSpacePattern<'a> {
    pub fn new(pat: &'a str) -> Self {
        assert_ne!(pat.len(), 0);

        let pat_bytes = pat.as_bytes();
        let (alphabet, skip) = B5SSpacePattern::build(pat_bytes);

        B5SSpacePattern { pat_bytes, alphabet, skip}
    }

    fn build(p: &'a [u8]) -> (BytesBloomFilter, usize)  {
        let mut alphabet = BytesBloomFilter::new();
        let lastpos = p.len() - 1;
        let mut skip = p.len();

        for i in 0..p.len()-1 {
            alphabet.insert(&p[i]);

            if p[i] == p[lastpos] {
                skip = lastpos - i;
            }
        }

        alphabet.insert(&p[lastpos]);

        (alphabet, skip)
    }

    pub fn find_all(&self, string: &'a str) -> Vec<usize> {
        let mut result = vec![];
        let string_bytes = string.as_bytes();
        let pat_last_pos = self.pat_bytes.len() - 1;
        let patlen = self.pat_bytes.len();
        let stringlen = string_bytes.len();
        let mut string_index = pat_last_pos;

        while string_index < stringlen {
            if string_bytes[string_index] == self.pat_bytes[pat_last_pos] {
                if &string_bytes[string_index-pat_last_pos..string_index] == &self.pat_bytes[..patlen-1] {
                    result.push(string_index-pat_last_pos);
                }

                if string_index + 1 == stringlen {
                    break;
                }

                if !self.alphabet.contains(&string_bytes[string_index+1]) {
                    string_index += patlen + 1;  // sunday
                } else {
                    string_index += self.skip;  // horspool
                }
            } else {
                if string_index + 1 == stringlen {
                    break;
                }

                if !self.alphabet.contains(&string_bytes[string_index+1]) {
                    string_index += patlen + 1;  // sunday
                } else {
                    string_index += 1;
                }
            }

        }

        result
    }
}
```

è¿™ä¸ªç‰ˆæœ¬çš„ç®—æ³•ç›¸å¯¹äºå‰é¢çš„åç¼€åŒ¹é…ç®—æ³•ä¸å¤Ÿå¿«ï¼Œä½†å·®è·å¹¶ä¸å¤§ï¼Œä»ç„¶æ¯” KMP è¿™ç§å¿«å¾—å¤šï¼Œç‰¹åˆ«æ˜¯è€ƒè™‘åˆ°å®ƒæä¸ºä¼˜ç§€çš„ç©ºé—´å¤æ‚åº¦ï¼šè‡³å¤šä¸¤ä¸ª `u64` çš„æ•´æ•°ï¼Œè¿™ç¡®å®æ˜¯æä¸ºå®ç”¨çš„é€‚åˆä½œä¸ºæ ‡å‡†åº“å®ç°çš„ä¸€ç§ç®—æ³•ï¼

## ç†è®ºåˆ†æ

ç°åœ¨æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æ¦‚ç‡æ¨¡å‹æ¥åšä¸€äº›ç»ä¸æ¯ç‡¥çš„ç†è®ºä¸Šçš„åˆ†æï¼Œå€Ÿæ­¤å¯ä»¥å‘ç°ä¸€äº›æœ‰è¶£è€Œæ›´æ·±å…¥çš„äº‹å®ã€‚

### å»ºç«‹æ¨¡å‹

æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ»‘åŠ¨å­—ç¬¦ä¸² $pat$ åˆ°æŸä¸ªæ–°çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®è¿˜æ²¡æœ‰å®ŒæˆåŒ¹é…ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å‘ç°å¤±é…æ‰€éœ€è¦çš„ä»£ä»·ä¸å‘ç°å¤±é…å $pat$ èƒ½å¤Ÿå‘ä¸‹æ»‘åŠ¨çš„å­—ç¬¦æ•°çš„æ¯”å€¼æ¥è¡¡é‡ç®—æ³•çš„å¹³å‡æ€§èƒ½è¡¨ç°ã€‚

å‡å¦‚è¿™ä¸ªä»£ä»·æ˜¯ç”¨å¯¹ $string$ çš„å¼•ç”¨æ¥è¡¡é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“å¹³å‡æ¯ä¸ªå­—ç¬¦éœ€è¦å¤šå°‘æ¬¡ $string$ çš„å¼•ç”¨ï¼Œè¿™æ˜¯åœ¨ç†è®ºä¸Šè¡¡é‡ç®—æ³•è¡¨ç°çš„å…³é”®æŒ‡æ ‡ï¼›

è€Œå¦‚æœè¿™ä¸ªä»£ä»·æ˜¯ç”¨æœºå™¨æŒ‡ä»¤è¡¡é‡ï¼Œé‚£æˆ‘ä»¬å¯ä»¥çŸ¥é“å¹³å‡æ¯ä¸ªå­—ç¬¦éœ€è¦å¤šå°‘æ¡æœºå™¨æŒ‡ä»¤ï¼›

å½“ç„¶ä¹Ÿå¯ä»¥æœ‰å…¶ä»–çš„è¡¡é‡æ–¹å¼ï¼Œè¿™å¹¶ä¸å½±å“ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨å¯¹ $string$ çš„å¼•ç”¨è¿›è¡Œç†è®ºåˆ†æã€‚

åŒæ—¶ä¸ºæˆ‘ä»¬çš„æ¦‚ç‡æ¨¡å‹æå‡ºä¸€ä¸ªå‡è®¾ï¼š$pat$ï¼Œ$string$ ä¸­çš„æ¯ä¸ªå­—ç¬¦æ˜¯ç‹¬ç«‹éšæœºå˜é‡ï¼Œå®ƒä»¬å‡ºç°çš„æ¦‚ç‡ç›¸ç­‰ï¼Œä¸º $p$ï¼Œ$p$ å–å†³äºå…¨å­—æ¯è¡¨çš„å¤§å°ã€‚

æ˜¾ç„¶ï¼Œå‡å¦‚å…¨å­—æ¯è¡¨çš„å¤§å°ä¸º $q$ï¼Œåˆ™ $p=\dfrac{1}{q}$ï¼Œä¾‹å¦‚å‡è®¾æˆ‘ä»¬ä¹‹å‰åŸºäºå­—èŠ‚çš„å®ç°ï¼Œåœ¨æ—¥å¸¸ä¸€èˆ¬æœç´¢æ—¶ï¼Œå¯ä»¥è¿‘ä¼¼ä¸º $q=\dfrac{1}{256}$ã€‚

ç°åœ¨å¯ä»¥æ›´å‡†ç¡®åœ°åˆ»ç”»è¿™ä¸ªæ¯”ç‡ï¼Œ$rate(patlen, p)$ï¼š

$$
\frac{\sum_{m=0}^{patlen-1} cost(m) \times prob(m)}{\sum_{m=0}^{patlen-1}prob(m) \times \sum_{k=1}^{patlen}skip(m,k) \times k }
$$

å…¶ä¸­ï¼Œ$cost(m)$ ä¸ºå‰é¢è®¨è®ºåˆ°çš„åœ¨åŒ¹é…æˆåŠŸäº† $m$ ä¸ªå­—ç¬¦åå¤±é…æ—¶çš„ä»£ä»·ï¼š

$$
cost(m) = m+1
$$

$prob(m)$ ä¸ºåŒ¹é…æˆåŠŸ $m$ ä¸ªå­—ç¬¦åå¤±é…çš„æ¦‚ç‡ï¼ˆå…¶ä¸­ $1-p^{patlen}$ æ’é™¤æ‰ $pat$ å…¨éƒ¨åŒ¹é…çš„æƒ…å†µï¼‰ï¼š

$$
prob(m) = \frac{p^m(1-p)}{1-p^{patlen}}
$$

$skip(m,k)$ ä¸ºå‘ç”Ÿå¤±é…æ—¶ $pat$ å‘ä¸‹æ»‘åŠ¨ $k$ ä¸ªå­—ç¬¦çš„æ¦‚ç‡ï¼Œï¼ˆè¿™é‡Œçš„ $k$ å¦‚åŒå‰æ–‡è®¨è®ºçš„ $k$ ä¸€æ ·ï¼Œä¸º $pat$ å®é™…æ»‘åŠ¨è·ç¦»ï¼Œä¸åŒ…æ‹¬æŒ‡é’ˆä»å¤±é…ä½ç½®å›é€€åˆ° $patlastpos$ ä½ç½®çš„è·ç¦»ï¼‰ã€‚å®é™…ä¸Šæ‰€æœ‰å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•çš„æ ¸å°±åœ¨äº $skip(m,k)$ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šé€šè¿‡åˆ†æ $delta_1$ å’Œ $delta_2$ æ¥è®¡ç®— BoyerMoore ç®—æ³•çš„ $skip(m,k)$ã€‚

### è®¡ç®— BoyerMoore ç®—æ³•çš„ $skip(m,k)$

#### $delta_1$

é¦–å…ˆè€ƒè™‘ $delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å‘ç°å¤±é…å­—ç¬¦åœ¨ $pat$ ä¸Šé‡ç°çš„ä½ç½®åœ¨å·²ç»åŒ¹é…å®Œçš„ $m$ ä¸ªå­—ç¬¦ä¸­ï¼Œè¿™ç§æƒ…å†µçš„æ¦‚ç‡ $\textit{probdelta_1_worthless}$ ä¸ºï¼š

$$
\textit{probdelta1_worthless}(m) = 1 - (1-p)^m
$$

è€Œå¯¹äº $delta_1$ èµ·ä½œç”¨çš„æƒ…å†µï¼Œå¯ä»¥æ ¹æ® k çš„èŒƒå›´åˆ†ä¸ºå››ç§æƒ…å†µè¿›è¡Œè®¨è®ºï¼š

1.  å½“ $k = 1$ æ—¶ï¼š

    1. å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®çš„ä¸‹ä¸€ä¸ªå­—ç¬¦æ°å¥½ç­‰äºå¤±é…å­—ç¬¦ï¼›

    2. å¤±é…å­—ç¬¦å·²ç»æ˜¯ $pat$ å³æ‰‹èµ·æœ€åä¸€ä¸ªå­—ç¬¦ã€‚

2. å½“ $1 < k < patlen-m$ æ—¶ï¼Œ$pat$ åœ¨å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®çš„å·¦è¾¹è¿˜æœ‰ä¸å¤±é…å­—ç¬¦ç›¸ç­‰çš„å­—ç¬¦ï¼Œå¹¶ä¸”ä¸æ»¡è¶³æƒ…å†µ 1ï¼›

3. å½“ $k = patlen - m$ æ—¶ï¼Œ$pat$ åœ¨å¤±é…å­—ç¬¦å¯¹åº”ä½ç½®å·¦è¾¹æ‰¾ä¸åˆ°å¦ä¸€ä¸ªä¸å¤±é…å­—ç¬¦ç›¸ç­‰çš„å­—ç¬¦ï¼Œå¹¶ä¸”ä¸æ»¡è¶³æƒ…å†µ 1ï¼Œè¿™æ—¶ $pat$ æœ‰æœ€å¤§å¯èƒ½çš„å‘ä¸‹æ»‘åŠ¨è·ç¦»ï¼›

4. å½“ $k > patlen - m$ æ—¶ï¼Œæ˜¾ç„¶å¯¹äº $delta_1$ï¼Œè¿™æ˜¯ä¸å¯èƒ½å­˜åœ¨çš„æƒ…å†µã€‚

äºæ˜¯æœ‰è®¡ç®— $delta_1$ çš„æ¦‚ç‡å‡½æ•°ï¼š

$$
probdelta1(m,k) =
\left\{ \begin{array}{lcl}
(1-p)^m\times \left\{ \begin{array}{lcl} 1  & \text{for} &m+1=patlen \\ p &\text{for}&m+1\neq patlen  \\\end{array}\right. & \text{for} & k = 1 \\
(1-p)^{m+k-1}\times p & \text{for} & 1 < k < patlen - m\\
(1-p)^{patlen-1} & \text{for} & k = patlen - m\\
0 & \text{for} & patlen patlen - m < k \leqslant patlen
\end{array}\right.
$$

#### $delta_2$

å¯¹äº $delta_2$ æ¦‚ç‡çš„è®¡ç®—ï¼Œæ ¹æ®å®šä¹‰ï¼Œé¦–å…ˆè®¡ç®—æŸä¸ª $subpat$ çš„é‡ç°çš„æ¦‚ç‡ï¼Œåªè¦è€ƒè™‘è¯¥é‡ç°å·¦è¾¹è¿˜æœ‰æ²¡æœ‰å­—ç¬¦æ¥æä¾›é¢å¤–çš„åˆ¤æ–­ä¸å¤±é…å­—ç¬¦æ˜¯å¦ç›¸ç­‰çš„æ£€æŸ¥ï¼š

$$
probpr(m,k) =
\left\{ \begin{array}{lcl}
(1-p)\times p^m & \text{for} & 1 \leqslant k < patlen - m\\
p^{patlen-k} & \text{for} & patlen - m \leqslant k \leqslant patlen
\end{array}\right.
$$

äºæ˜¯ $delta_2(m,k)$ å°±å¯ä»¥é€šè¿‡ä¿è¯ $pr(m,k)$ å­˜åœ¨å¹¶ä¸” $k$ æ›´å°çš„ $delta_2$ ä¸å­˜åœ¨ï¼Œæ¥é€’å½’è®¡ç®—ï¼š

$$
probdelta2(m,k) = probpr(m,k)(1-\sum_{n=1}^{k-1}probdelta2(m, n))
$$

#### æ±‡æ€»

å‰é¢å·²ç»ç‹¬ç«‹è®¨è®ºäº† $delta_1$ï¼Œ$delta_2$ çš„æ¦‚ç‡å‡½æ•°ï¼Œä¸è¿‡è¿˜éœ€è¦é¢å¤–è€ƒè™‘ä¸€ä¸‹è¿™ä¸¤ä¸ªæ¦‚ç‡å‡½æ•°ä¹‹é—´ç›¸äº’å½±å“çš„æƒ…å†µï¼Œè™½ç„¶åªæ˜¯ä¸€ä¸ªå¾ˆå°‘æ•°çš„æƒ…å†µï¼š

å½“ $delta_2$ è®¡ç®—çš„ $k$ ä¸º 1 çš„æ—¶å€™ï¼Œæ ¹æ® $delta_2$ å®šä¹‰æˆ‘ä»¬å°±çŸ¥é“ $pat[-(m+1)] = pat[-m]=pat[-(m-1)]\dots pat[-1]$ï¼Œï¼ˆ$pat[-n]$ è¡¨ç¤º $pat$ çš„å€’æ•°ç¬¬ $n$ ä¸ªå­—ç¬¦ï¼Œä¸‹åŒï¼‰ã€‚è€Œè¿™ç§æƒ…å†µå·²ç»æ’é™¤äº† $delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µï¼Œå› ä¸ºå½“å¦‚å‰æ–‡è®¨è®ºçš„ï¼Œ$delta_1$ ä¸èµ·ä½œç”¨è¦æ±‚ä¸å¤±é…å­—ç¬¦ $pat[-(m+1)]$ ç›¸ç­‰çš„å­—ç¬¦å‡ºç°åœ¨ $pat[-m]\dots pat[-1]$ ä¸­ï¼Œè¿™å°±äº§ç”Ÿäº†ä¸å¯èƒ½åœ¨å€’æ•° $m+1$ ä¸ªå­—ç¬¦ä¸Šå¤±é…çš„çŸ›ç›¾ã€‚

å› æ­¤é’ˆå¯¹ $delta_1$ ä¸èµ·ä½œç”¨çš„æƒ…å†µéœ€è¦ä¸€ä¸ªç¨å¾®ä¿®æ”¹è¿‡çš„ $delta_2$ æ¦‚ç‡å‡½æ•°ï¼š

$$
probdelta2'(m,k) =
\left\{ \begin{array}{lcl}
0 & \text{for} & k = 1\\
probpr(m,k)(1-\sum_{n=2}^{k-1}probdelta2'(m, n)) & \text{for} & 1 \leqslant k \leqslant patlen
\end{array}\right.
$$

äºæ˜¯é€šè¿‡ç»„åˆ $delta_1$ å’Œ $delta_2$ èµ·ä½œç”¨çš„æƒ…å†µï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† BoyerMoore ç®—æ³•çš„ $skip$ æ¦‚ç‡å‡½æ•°ï¼š

$$
skip(m,k) = \left\{\begin{array}{lcl}
probdelta1(m, 1) \times probdelta2(m, 1) & \text{for} & k = 1\\
\\
\\
\\
\textit{prodelta1_worthless}(m)\times probdelta2'(m, 1)\\
+\ probdelta1(m, k)\times \sum_{n=1}^{k-1}probdelta2(m, n)\\
+\ probdelta2(m, k)\times \sum_{n=1}^{k-1}probdelta1(m,n)\\
+\ probdelta1(m, k)\times probdelta2(m, k)
& \text{for} & 1 < k \leqslant patlen
\end{array}\right.
$$

### åˆ†ææ¯”è¾ƒ

ä¸ºäº†ç»“æ„æ¸…æ™°ã€ä¹¦å†™ç®€å•ã€æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬ä½¿ç”¨ Python å¹³å°çš„ Lisp æ–¹è¨€ Hy æ¥è¿›è¡Œå®é™…è®¡ç®—ï¼š

`myprob.hy`

```Hy
(require [hy.contrib.sequences [defseq seq]])

(import [hy.contrib.sequences [Sequence end-sequence]])
(import [hy.models [HySymbol]])


(defmacro simplify-probfn [patlen p probfn-list]
    "(prob-xxx patlen p m k) -> (prob-xxx-s m k)"
    (lfor probfn probfn-list
        [(setv simplified-probfn-symbol (HySymbol (.format "{}-s" (name probfn))))
        `(defn ~simplified-probfn-symbol [&rest args] (~probfn patlen p #*args))]))


(defn map-sum [range-args func]
    (setv [start end] range-args)
    (-> func (map (range start (inc end))) sum))


(defn cost [m] (+ m 1))


(defn prob-m [patlen p m]
    (/
        (* (** p m) (- 1 p))
        (- 1 (** p patlen))))


(defn prob-delta1 [patlen p m k]
    (cond [(= 1 k) (* (** (- 1 p) m)
                      (if (= (inc m) patlen) 1 p))]
          [(< k (- patlen m)) (* p (** (- 1 p) (dec (+ k m))))]
          [(= k (- patlen m)) (** (- 1 p) (dec patlen))]
          [(> k (- patlen m)) 0]))


(defn prob-delta1-worthless [p m] (- 1 (** (- 1 p) m)))


(defn prob-pr [patlen p m k] (if (< patlen (+ m k))
                                (* (- 1 p) (** p m))
                                (** p (- patlen k))))


(defn prob-delta2 [patlen p m]
    "prob-delta2(_, k) = prob-delta2-seq[k]"
    (defseq prob-delta2-seq [n]
        (cond [(< n 1) 0]
              [(= n 1) (prob-pr patlen p m 1)]
              [(> n 1) (* (prob-pr patlen p m n) (- 1 (sum (take n prob-delta2-seq))))]))
    prob-delta2-seq)


(defn prob-delta2-1 [patlen p m]
    (defseq prob-delta2-1-seq [n]
        (cond [(< n 2) 0]
              [(>= n 2) (* (prob-pr patlen p m n) (- 1 (sum (take n prob-delta2-1-seq))))]))
    prob-delta2-1-seq)


(defn skip [patlen p m k prob-delta2-seq prob-delta2-1-seq]
    (simplify-probfn patlen p [prob-delta1])
    (if (= k 1) (* (prob-delta1-s m 1) (get prob-delta2-seq 1))
        (sum [(* (prob-delta1-worthless p m) (get prob-delta2-1-seq k))
              (* (prob-delta1-s m k) (sum (take k prob-delta2-seq)))
              (* (get prob-delta2-seq k) (map-sum [1 (- k 1)]
                                                  (fn [n] (prob-delta1-s m n))))
              (* (prob-delta1-s m k) (get prob-delta2-seq k))])))


(defn bm-rate [patlen p]
    (simplify-probfn patlen p [prob-m prob-delta2 prob-delta2-1 skip])
    (/
        (map-sum [0 (dec patlen)]
            (fn [m] (* (cost m) (prob-m-s m))))

        (map-sum [0 (dec patlen)]
            (fn [m]
                (setv prob-delta2-seq (prob-delta2-s m)
                      prob-delta2-1-seq (prob-delta2-1-s m))
                (* (prob-m-s m) (map-sum [1 patlen]
                                    (fn [k] (* k (skip-s m k prob-delta2-seq prob-delta2-1-seq)))))))))
```

å¹¶ä¸”ä¸ºäº†è¿›è¡Œæ¯”è¾ƒï¼Œè¿˜é¢å¤–è®¡ç®—äº†ç®€åŒ– BM ç®—æ³•ï¼š

`myprob.hy`

```hy
(defn simplified-bm-skip [patlen p m k]
    (simplify-probfn patlen p [prob-delta1])
    (if (= k 1) (+ (prob-delta1-s m 1) (prob-delta1-worthless p m))
        (prob-delta1-s m k)))


(defn sbm-rate [patlen p]
    (simplify-probfn patlen p [prob-m simplified-bm-skip])
    (/
        (map-sum [0 (dec patlen)]
            (fn [m] (* (cost m) (prob-m-s m))))

        (map-sum [0 (dec patlen)]
            (fn [m] (* (prob-m-s m) (map-sum [1 patlen]
                                        (fn [k] (* k (simplified-bm-skip-s m k)))))))))
```

å’Œ KMP ç®—æ³•ï¼š

`myprob.hy`

```hy
(defn getone [&rest body &kwonly [default None]]
  (try
    (get #*body)
    (except [_ [IndexError KeyError TypeError]]
      default)))


(defn prob-pi [patlen p]
    "prob-pi-s(m, l) = prob-pi-seq[m][l]"
    (defseq prob-pi-seq [n]
        (cond [(= n 0) []]
              [(= n 1) [1]]
              [(= n 2) [(- 1 p) p]]
              [(> n 2) (lfor i (range n)
                            (+
                                (* (getone prob-pi-seq (dec n) i :default 0) (- 1 p))
                                (* (get prob-pi-seq (dec n) (dec i)))))]))
    prob-pi-seq)


(defn skip [m k prob-pi-seq]
    (if (= m 0) (if (= k 1) 1 0)
        (get prob-pi-seq m (- m k))))


(defn at-least-1 [n]
    (if (< n 1) 1 n))


(defn kmp-rate [patlen p]
    (simplify-probfn patlen p [prob-m prob-pi])
    (setv prob-pi-seq (prob-pi-s))
    (/
        (map-sum [0 (dec patlen)]
            (fn [m] (* (cost m) (prob-m-s m))))

        (map-sum [0 (dec patlen)]
            (fn [m] (* (prob-m-s m) (map-sum [1 (at-least-1 (dec m))]
                                        (fn [k] (* k (skip m k prob-pi-seq)))))))))
```

ç„¶åæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ Python ä¸Šçš„ `plotnine` å›¾å½¢åŒ…çœ‹ä¸€ä¸‹è®¡ç®—çš„æ•°æ®ï¼ˆå¹¶ç”¨é«˜æ–¯è¿‡ç¨‹å›å½’æ‹Ÿåˆæ›²çº¿ï¼‰ï¼š

```python
import pandas as pd
from plotnine import *
import hy

from my_prob import bm_rate, sbm_rate, kmp_rate


theme_update(text=element_text(family="SimHei"))

def plot(p, title, N=30):
    model_range = range(1, N+1)
    data = {'rate':[], 'alg':[], 'patlen':[]}
    categories_list = [(bm_rate, 'BoyerMoore'),
                       (sbm_rate, 'S BoyerMoore'),
                       (kmp_rate, 'KMP'),
                       (lambda patlen, p: 1/patlen, '$\\frac{1}{patlen}$')]

    for alg_fun, label in categories_list:
        data['rate'].extend([alg_fun(patlen, p) for patlen in model_range])
        data['alg'].extend([label for _ in model_range])
        data['patlen'].extend(model_range)

    df = pd.DataFrame(data)

    return (ggplot(df, aes(x='patlen', y='rate', color='alg'))
            + geom_point()
            + geom_smooth(method='gpr')
            + labs(color='Algs', title=title, x='$patlen$', y='$\\frac{cost}{skip}$'))
```

`plot(1/256, '$p= \\frac{1}{256}$')`ï¼š

<img src="../images/BM/plot256.svg" style="zoom: 200%;" />

è§‚å¯Ÿè¿™ä¸ªå›¾åƒï¼Œä»¤äººå°è±¡æ·±åˆ»çš„é¦–å…ˆå°±æ˜¯æŠ¬å¤´çš„ä¸€æ¡å¤§å…°çº¿ï¼Œå‡ ä¹ç¬”ç›´åœ°ç”»å‡ºäº†ç®—æ³•æ€§èƒ½çš„ä¸‹é™ï¼Œä¸æ„§æ˜¯ KMP ç®—æ³•ï¼Œ$O(n)$ çš„æ—¶é—´å¤æ‚åº¦ï¼Œä¸€çœ‹å°±å¾ˆçœŸå®ï¼ˆï¾Ÿâ–½ï¾Ÿ)/ã€‚

æ¥ç€ä¼šå‘ç° BoyerMoore ç®—æ³•ä¸ç®€åŒ–ç‰ˆ BoyerMoore ç®—æ³•é«˜åº¦é‡å çš„è¿™æ¡çº¢ç»¿ç´«æ›²çº¿ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ $\dfrac{1}{patlen}$ï¼Œ

è¿™å°±æ˜¯åœ¨ä¸€èˆ¬å­—ç¬¦é›†ä¸‹éšæœºæ–‡æœ¬æœç´¢èƒ½è¾¾åˆ°çš„ $O(\dfrac{n}{m})$ çš„å¼ºåŠ›ç®—æ³•å—ï¼Ÿ(ï¾Ÿâ–³ï¾Ÿ;ï¾‰)ï¾‰

å¦å¤–æ­¤æ—¶å¯ä»¥ç»å¤§å¤šæ•°çš„å­—ç¬¦è·³è½¬ä¾é  $delta_1$ï¼ˆæ¯” $delta_2$ é«˜å‡ ä¸ªæ•°é‡ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯åŸºäº $delta_1$ è¡¨çš„ BM å˜ç§ç®—æ³•æœ€ä½³çš„åº”ç”¨åœºæ™¯ï¼

æ¥ç€æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹åœ¨ç»å…¸çš„å°å­—ç¬¦é›†ï¼Œæ¯”å¦‚åœ¨ DNA {A, C, T, G} ç¢±åŸºå¯¹åºåˆ—ä¸­ç®—æ³•çš„æ€§èƒ½è¡¨ç°ï¼ˆ`plot(1/4, '$p= \\frac{1}{4}$')`ï¼‰ï¼š

<img src="../images/BM/plot4.svg" style="zoom:200%;" />

æ›²çº¿å‡ºç°äº†æ˜æ˜¾çš„åˆ†åŒ–ï¼Œå½“ç„¶ KMP è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€åœ°ç¨³å®šï¼ˆï¾Ÿâ–½ï¾Ÿ)/ï¼Œå¦‚æœæ­¤æ—¶åœ¨æµ‹è¯•ä¸­ç›‘æ§ä¸€ä¸‹ä¸€ä¸‹ $delta_1$ è¡¨å’Œ $delta_2$ è¡¨ä½œç”¨æƒ…å†µä¼šå‘ç°ï¼š$delta_2$ èµ·ä½œç”¨çš„æ¬¡æ•°è¶…è¿‡äº† $delta_1$ï¼Œè€Œä¸” $delta_2$ è´¡çŒ®çš„è·³è¿‡å­—ç¬¦æ•°æ›´æ˜¯è¿œè¶… $delta_1$ï¼Œæ€è€ƒä¸‹ï¼Œè¿™ä»¶äº‹å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œé€šè¿‡æ¦‚ç‡æ¨¡å‹çš„è®¡ç®—ï¼Œä¸€æ–¹é¢çœ‹åˆ°äº†åœ¨è¾ƒå¤§çš„å­—ç¬¦é›†ï¼Œæ¯”å¦‚æ—¥å¸¸æœç´¢çš„è¿‡ç¨‹ä¸­ BoyerMoore ç³»åˆ—ç®—æ³•çš„ä¼˜è¶Šè¡¨ç°ï¼Œå…¶ä¸­ä¸»è¦ä¾èµ– $delta_1$ è¡¨å®ç°å­—ç¬¦è·³è½¬ï¼›å¦ä¸€æ–¹é¢ï¼Œåœ¨è¾ƒå°çš„å­—ç¬¦é›†é‡Œï¼Œ$delta_1$ çš„ä½œç”¨ä¸‹é™ï¼Œè€Œ $delta_2$ çš„ä½œç”¨å¾—åˆ°äº†ä½“ç°ã€‚å¦‚æœæœ‰ä¸€å®šå¯Œè£•ç©ºé—´çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å®Œæ•´çš„ç©ºé—´å¤æ‚åº¦ä¸º $O(m)$ çš„ BoyerMoore ç®—æ³•åº”è¯¥æ˜¯ä¸€ç§é€‚ç”¨å„ç§æƒ…å†µã€ç»¼åˆè¡¨ç°éƒ½å¾ˆä¼˜å¼‚çš„ç®—æ³•é€‰æ‹©ã€‚

## å¼•ç”¨

[^bm]: [1977 å¹´ Boyer-Moore ç®—æ³•è®ºæ–‡](https://dl.acm.org/doi/10.1145/359842.359859)

[^kmp]: [1977 å¹´ KMP ç®—æ³•è®ºæ–‡](https://epubs.siam.org/doi/abs/10.1137/0206024)

[^rytter]: [1980 å¹´ Rytter çº æ­£ Knuth çš„è®ºæ–‡](https://epubs.siam.org/doi/10.1137/0209037)

[^galil-rule]: [1979 å¹´ä»‹ç» Galil ç®—æ³•çš„è®ºæ–‡](https://doi.org/10.1145%2F359146.359148)

[^b5s]: [B5S ç®—æ³•çš„ä»‹ç»](http://effbot.org/zone/stringlib.htm#BMHBNFS)
